<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matrix Blueprint 2026 - Auto Gen AI</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- ✅ SheetJS with STYLE support (export màu ô Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

  <style>
    :root{
      --primary:#2563EB;
      --bg-body:#F8FAFC;
      --border-color:#E2E8F0;

      /* Bloom Colors */
      --bloom-1:#FEE2E2;
      --bloom-2:#FFEDD5;
      --bloom-3:#FEF9C3;
      --bloom-4:#DCFCE7;
      --bloom-5:#DBEAFE;
      --bloom-6:#F3E8FF;
    }

    body{
      font-family:'Inter',sans-serif;
      background-color:var(--bg-body);
      color:#1E293B;
      height:100vh;
      overflow:hidden;
      font-size:13px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:4px}
    ::-webkit-scrollbar-thumb:hover{background:#94A3B8}

    /* Navigation */
    .nav-item{cursor:pointer;transition:all .2s ease;border-bottom:2px solid transparent}
    .nav-item:hover{color:var(--primary);background-color:#EFF6FF}
    .nav-item.active{color:var(--primary);border-bottom-color:var(--primary);background-color:#EFF6FF;font-weight:600}

    /* Sidebar */
    .sidebar-item{
      border-radius:6px;transition:all .2s;cursor:pointer;border-left:3px solid transparent;position:relative
    }
    .sidebar-item:hover{background-color:#F1F5F9}
    .sidebar-item.active{
      background-color:#EFF6FF;color:#1D4ED8;border-left-color:#2563EB;font-weight:600
    }
    .sidebar-actions{display:none}
    .sidebar-item:hover .sidebar-actions{display:flex}

    /* Matrix */
    .matrix-container{
      box-shadow:0 4px 6px -1px rgba(0,0,0,.1);
      border-radius:8px;border:1px solid var(--border-color);
      background:#fff;overflow:hidden;display:flex;flex-direction:column;height:100%;
    }
    .matrix-table{width:100%;border-collapse:separate;border-spacing:0}
    .matrix-table th{
      background-color:#F8FAFC;color:#475569;font-weight:600;font-size:.75rem;text-transform:uppercase;
      padding:8px;border-bottom:1px solid var(--border-color);border-right:1px solid var(--border-color);
      position:sticky;top:0;z-index:10;text-align:center;
    }
    .matrix-table th.corner-header{
      left:0;z-index:20;background-color:#F1F5F9;text-align:left;min-width:400px;
    }
    .matrix-table td{
      border-bottom:1px solid var(--border-color);border-right:1px solid var(--border-color);
      padding:0;height:44px;position:relative;
    }
    .matrix-table td.row-header{
      padding:0 10px;position:sticky;left:0;background:#fff;z-index:5;font-weight:500;
      white-space:normal;line-height:1.3;max-width:400px;box-shadow:2px 0 5px -2px rgba(0,0,0,.05);
    }
    .row-action-btn{opacity:0;transition:opacity .2s}
    .matrix-table tr:hover .row-action-btn{opacity:1}
    .matrix-table tr.footer-row td{
      background-color:#F1F5F9;position:sticky;bottom:0;z-index:9;border-top:2px solid #CBD5E1;
      font-weight:700;color:#1E40AF;
    }
    .matrix-table tr.footer-row td.row-header{
      z-index:15;text-align:right;padding-right:15px;color:#475569;text-transform:uppercase;font-size:.75rem;
    }

    /* Matrix cell */
    .matrix-cell{
      width:100%;height:100%;display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-weight:800;font-size:14px;transition:all .15s;
      user-select:none;
    }
    .matrix-cell:hover{filter:brightness(.95);box-shadow:inset 0 0 0 2px #94A3B8}
    .matrix-cell.empty{background:transparent;color:transparent}
    .matrix-cell.empty:hover{background:#F1F5F9}

    .bloom-1{background-color:var(--bloom-1);color:#991B1B}
    .bloom-2{background-color:var(--bloom-2);color:#9A3412}
    .bloom-3{background-color:var(--bloom-3);color:#854D0E}
    .bloom-4{background-color:var(--bloom-4);color:#166534}
    .bloom-5{background-color:var(--bloom-5);color:#1E40AF}
    .bloom-6{background-color:var(--bloom-6);color:#6B21A8}

    .legend-dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:4px;border:1px solid rgba(0,0,0,.1)}

    /* Popover Editor */
    #cellEditor{
      position:fixed;background:#fff;border:1px solid #CBD5E1;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1);
      border-radius:8px;padding:12px;z-index:100;display:none;width:260px;
    }
    .bloom-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:8px}
    .bloom-opt{height:30px;border-radius:4px;cursor:pointer;border:2px solid transparent}
    .bloom-opt.selected{border-color:#2563EB;transform:scale(.95)}

    .stat-card{background:#fff;border:1px solid #E2E8F0;border-radius:6px;padding:4px 10px;min-width:80px}

    /* Tabs */
    .tab-btn{padding:.5rem 1rem;font-weight:600;color:#64748B;border-bottom:2px solid transparent;cursor:pointer;transition:all .2s}
    .tab-btn:hover{color:#2563EB}
    .tab-btn.active{color:#2563EB;border-bottom-color:#2563EB}

    .config-input{
      width:60px;text-align:center;border:1px solid #CBD5E1;border-radius:4px;padding:4px;transition:all .2s;
    }
    .config-input:focus{border-color:#2563EB;outline:none}

    .clo-desc-input{
      width:100%;border:1px solid #E2E8F0;border-radius:4px;padding:8px;font-size:13px;outline:none;
      transition:border-color .2s;
    }
    .clo-desc-input:focus{border-color:#2563EB}

    /* Live bars */
    .monitor-bar-bg{width:100%;height:6px;background:#F1F5F9;border-radius:3px;overflow:hidden;margin-top:4px}
    .monitor-bar-fill{height:100%;transition:width .5s ease;border-radius:3px}

    .text-problem{white-space:normal;font-size:12px;line-height:1.4;outline:none;border:1px dashed transparent;padding:2px}
    .text-problem:focus{border-color:#94A3B8;background:#F8FAFC}

    /* Export menu */
    .export-group{position:relative}
    .export-dropdown{
      position:absolute;right:0;top:100%;margin-top:5px;background:#fff;border:1px solid #E2E8F0;
      border-radius:6px;box-shadow:0 10px 15px -3px rgba(0,0,0,.1);display:none;min-width:200px;z-index:50;
    }
    .export-group:hover .export-dropdown{display:block}
    .export-item{display:block;padding:8px 12px;font-size:13px;color:#334155;cursor:pointer}
    .export-item:hover{background-color:#F1F5F9;color:#0F172A}

    .cloud-pill{
      display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid #E2E8F0;border-radius:999px;
      font-size:12px;background:#fff;
    }

    /* Lock button UI (Cell editor) */
    .lock-on  { background:#FEE2E2; color:#B91C1C; border-color:#FECACA; }
    .lock-off { background:#F1F5F9; color:#334155; border-color:#E2E8F0; }

    /* Cell locked overlay icon */
    .matrix-cell.locked{
      position:relative;
      opacity:0.55;
      filter:grayscale(0.2);
    }
    .matrix-cell.locked::after{
      content:"\f023"; /* fa-lock */
      font-family:"Font Awesome 6 Free";
      font-weight:900;
      position:absolute;
      top:4px; right:6px;
      font-size:10px;
      color:#ef4444;
      pointer-events:none;
    }

    /* tiny toast */
    #toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#0f172a;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      box-shadow:0 10px 20px rgba(0,0,0,.2);
      z-index:200;
      display:none;
      max-width:90vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* NEW: disabled cell (CLO not applied for this problem) */
    .matrix-cell.disabled {
      background: #f8fafc;
      color: #94a3b8;
      cursor: not-allowed;
      opacity: 0.75;
      filter: grayscale(0.35);
    }
    .matrix-cell.disabled:hover {
      box-shadow: none;
      filter: none;
    }

    /* NEW: mini button in row header */
    .row-mini-btn{
      font-size:11px;
      font-weight:800;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #e2e8f0;
      color:#475569;
      background:#fff;
    }
    .row-mini-btn:hover{
      background:#f1f5f9;
      color:#0f172a;
    }

    /* NEW: modal for per-problem CLO */
    #problemCloModalBackdrop{
      position:fixed; inset:0;
      background:rgba(15,23,42,.35);
      z-index:300;
      display:none;
    }
    #problemCloModal{
      position:fixed;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:min(520px,92vw);
      background:#fff;
      border:1px solid #e2e8f0;
      border-radius:12px;
      box-shadow:0 20px 40px rgba(0,0,0,.18);
      z-index:310;
      display:none;
      overflow:hidden;
    }
    #problemCloModal .pm-head{
      padding:12px 14px;
      background:#f8fafc;
      border-bottom:1px solid #e2e8f0;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    #problemCloModal .pm-body{
      padding:12px 14px;
      max-height:55vh;
      overflow:auto;
    }
    #problemCloModal .pm-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 8px;
      border:1px solid #f1f5f9;
      border-radius:10px;
      margin-bottom:8px;
    }
    #problemCloModal .pm-row:hover{ background:#f8fafc; }
    .pm-pill{
      font-size:11px;
      font-weight:800;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #e2e8f0;
      background:#fff;
      color:#334155;
    }
    .pm-pill.on { background:#dcfce7; border-color:#bbf7d0; color:#166534; }
    .pm-pill.off{ background:#fee2e2; border-color:#fecaca; color:#991b1b; }
  </style>
</head>

<body class="flex flex-col">
  <!-- HEADER -->
  <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 z-30 shadow-sm flex-none">
    <div class="flex items-center gap-6">
      <div class="flex items-center text-blue-700">
        <i class="fa-solid fa-layer-group text-xl mr-2"></i>
        <div>
          <h1 class="font-bold text-base leading-tight text-slate-800">
            Matrix<span class="text-blue-600">Builder</span>
            <span class="text-xs font-normal text-slate-500">PRO - 2026</span>
          </h1>
        </div>
      </div>

      <!-- Legend -->
      <div class="flex items-center gap-3 text-xs bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100 hidden md:flex">
        <span class="font-bold text-slate-400 mr-1">BLOOM:</span>
        <div class="flex items-center" title="1. Ghi nhớ"><span class="legend-dot bloom-1"></span>L1</div>
        <div class="flex items-center" title="2. Hiểu"><span class="legend-dot bloom-2"></span>L2</div>
        <div class="flex items-center" title="3. Áp dụng"><span class="legend-dot bloom-3"></span>L3</div>
        <div class="flex items-center" title="4. Phân tích"><span class="legend-dot bloom-4"></span>L4</div>
        <div class="flex items-center" title="5. Đánh giá"><span class="legend-dot bloom-5"></span>L5</div>
        <div class="flex items-center" title="6. Sáng tạo"><span class="legend-dot bloom-6"></span>L6</div>
      </div>

      <!-- Cloud indicator -->
      <div class="cloud-pill hidden lg:inline-flex" title="Lưu/Tải state trên Vercel Blob">
        <i class="fa-solid fa-cloud text-slate-500"></i>
        <span class="text-slate-600 font-semibold">Cloud:</span>
        <span id="cloudStatus" class="text-slate-500">chưa tải</span>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <div class="stat-card">
        <div class="text-[10px] text-slate-500 font-bold uppercase">Tổng câu</div>
        <div class="text-lg font-bold text-slate-800" id="totalQuestionsDisplay">0</div>
      </div>

      <!-- CLOUD BUTTONS -->
      <button onclick="saveToCloud()" class="bg-slate-800 hover:bg-slate-900 text-white px-3 py-1.5 rounded text-sm font-medium flex items-center gap-2 transition-colors">
        <i class="fa-solid fa-cloud-arrow-up"></i> Lưu cloud
      </button>
      <button onclick="loadFromCloud()" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-3 py-1.5 rounded text-sm font-medium flex items-center gap-2 transition-colors">
        <i class="fa-solid fa-cloud-arrow-down"></i> Tải cloud
      </button>

      <div class="export-group">
        <button class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded text-sm font-medium flex items-center gap-2 transition-colors">
          <i class="fa-solid fa-file-excel"></i> Xuất Excel <i class="fa-solid fa-chevron-down text-[10px]"></i>
        </button>
        <div class="export-dropdown">
          <div onclick="exportRealExcel()" class="export-item font-bold border-b border-slate-100">
            <i class="fa-solid fa-table mr-2 text-emerald-600"></i> Xuất Ma trận hiện tại
          </div>
          <div onclick="downloadTemplate()" class="export-item text-slate-500">
            <i class="fa-solid fa-file-arrow-down mr-2"></i> Tải Form mẫu gốc
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <div class="flex flex-1 overflow-hidden relative">
    <!-- SIDEBAR -->
    <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-20">
      <div class="p-3 border-b border-slate-100 bg-slate-50 font-bold text-xs text-slate-500 uppercase flex justify-between">
        <span>Hệ thống cơ quan</span>
        <i class="fa-solid fa-list"></i>
      </div>

      <div class="flex-1 overflow-y-auto p-2 space-y-1" id="sidebarList"></div>

      <div class="p-3 border-t border-slate-200 flex flex-col gap-2">
        <button onclick="addSystem()" class="w-full py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 border border-blue-200 rounded text-xs font-bold transition-colors">
          <i class="fa-solid fa-folder-plus mr-1"></i> Thêm Hệ Thống
        </button>
        <button onclick="openCLOManager()" class="w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded text-xs font-bold transition-colors">
          <i class="fa-solid fa-bullseye mr-1"></i> Quản lý CLO (Thêm/Sửa/Xóa)
        </button>
      </div>
    </aside>

    <!-- WORKSPACE -->
    <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden">
      <!-- Tabs & Toolbar -->
      <div class="h-12 bg-white border-b border-slate-200 flex items-center justify-between px-4 flex-none">
        <div class="flex gap-4 h-full">
          <button onclick="switchTab('matrix')" id="tab-matrix" class="tab-btn active">
            <i class="fa-solid fa-table mr-1"></i> Ma trận
          </button>
          <button onclick="switchTab('clo-info')" id="tab-clo-info" class="tab-btn">
            <i class="fa-solid fa-circle-info mr-1"></i> Thông tin CLO
          </button>
          <button onclick="switchTab('config')" id="tab-config" class="tab-btn">
            <i class="fa-solid fa-sliders mr-1"></i> Cấu hình & Tạo tự động
          </button>
          <button onclick="switchTab('clo-manager')" id="tab-clo-manager" class="tab-btn">
            <i class="fa-solid fa-gear mr-1"></i> Quản lý CLO
          </button>
        </div>

        <div class="text-xs text-slate-400 italic" id="matrixHint">
          * Bấm vào tên để sửa. Chọn ô để nhập điểm. Chuột phải lên ô để khóa/mở khóa nhanh.
        </div>
      </div>

      <!-- CONTENT VIEWS -->
      <div class="flex-1 overflow-hidden relative">

        <!-- VIEW 1: MATRIX -->
        <div id="view-matrix" class="h-full flex flex-col p-4 view-section">
          <div class="mb-2 flex items-center">
            <h2 id="currentSystemTitle" class="font-bold text-slate-700 text-lg mr-3">Chọn hệ thống...</h2>
            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-medium">Đang chỉnh sửa</span>
          </div>

          <div class="matrix-container flex-1">
            <div class="overflow-auto h-full relative">
              <table class="matrix-table" id="mainMatrix">
                <thead id="matrixHead"></thead>
                <tbody id="matrixBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW 2: CLO INFO -->
        <div id="view-clo-info" class="h-full p-8 overflow-y-auto hidden view-section">
          <div class="max-w-4xl mx-auto bg-white rounded-lg border border-slate-200 shadow-sm p-6">
            <h3 class="font-bold text-slate-800 text-lg mb-4 flex items-center">
              <span class="w-8 h-8 rounded bg-indigo-100 text-indigo-600 flex items-center justify-center mr-2">
                <i class="fa-solid fa-book-open"></i>
              </span>
              Định nghĩa Chuẩn đầu ra (CLOs)
            </h3>

            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                  <tr>
                    <th class="px-4 py-3 w-24">Mã CLO</th>
                    <th class="px-4 py-3 w-48">Tên ngắn</th>
                    <th class="px-4 py-3">Mô tả chi tiết / Định nghĩa</th>
                  </tr>
                </thead>
                <tbody id="cloInfoBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW 3: CONFIG & AUTO GEN -->
        <div id="view-config" class="h-full p-6 overflow-y-auto hidden view-section">
          <div class="max-w-7xl mx-auto">

            <!-- Generator Panel -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-lg p-5 mb-6 flex items-center justify-between shadow-sm">
              <div>
                <h3 class="font-bold text-blue-800 text-lg mb-1">
                  <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Tạo Ma Trận Tự Động (AI Distribution)
                </h3>
                <p class="text-sm text-blue-600 opacity-80">
                  Hệ thống sẽ rải câu hỏi dựa trên <b>Tỉ trọng %</b> của các Hệ thống & Vấn đề đã cấu hình.
                  <br/>
                  <span class="text-xs">
                    * CLO có target toàn bài. Khóa/mở theo từng VẤN ĐỀ dùng chuột phải lên ô hoặc nút khóa trong editor.
                  </span>
                </p>
              </div>
              <div class="flex items-end gap-4">
                <div>
                  <label class="block text-xs font-bold text-blue-700 mb-1 uppercase">Tổng số câu hỏi</label>
                  <input type="number" id="autoTotalQ" value="110"
                         class="w-32 text-center text-lg font-bold border-2 border-blue-200 rounded px-2 py-1 text-blue-800 focus:border-blue-500 outline-none">
                </div>
                <button onclick="runAutoGenerator()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded shadow font-bold transition-all transform hover:scale-105">
                  <i class="fa-solid fa-play mr-2"></i> BẮT ĐẦU TẠO
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

              <!-- COL 1 -->
              <div class="lg:col-span-6 space-y-6">
                <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-5">
                  <h3 class="font-bold text-slate-800 text-base mb-4 flex items-center justify-between">
                    <div class="flex items-center">
                      <span class="w-7 h-7 rounded bg-orange-100 text-orange-600 flex items-center justify-center mr-2">
                        <i class="fa-solid fa-weight-scale"></i>
                      </span>
                      Tỉ trọng Hệ Thống & Vấn đề
                    </div>
                    <span class="text-xs font-normal text-slate-400">(Nhập tỉ trọng % hệ thống)</span>
                  </h3>

                  <div class="mb-4">
                    <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Chọn hệ thống để cấu hình:</label>
                    <select id="configSystemSelect" onchange="changeConfigSystem(this.value)"
                            class="w-full p-2 border border-slate-300 rounded text-sm font-semibold text-slate-700"></select>
                  </div>

                  <div class="p-3 bg-slate-50 border border-slate-200 rounded mb-4">
                    <div class="flex justify-between items-center">
                      <span class="text-sm font-bold text-slate-700">Tỉ trọng Hệ thống (%):</span>
                      <div class="flex items-center gap-2">
                        <input type="number" id="systemWeightInput" onchange="updateSystemWeight(this.value)"
                               class="config-input w-24 font-bold text-blue-700" step="0.01" placeholder="%">
                        <span class="text-xs text-slate-500 font-bold">%</span>
                      </div>
                    </div>
                    <div class="mt-2">
                      <div class="flex justify-between text-[10px] text-slate-500 mb-1">
                        <span>Tỉ lệ câu hỏi thực tế (toàn bài):</span>
                        <span id="systemActualPercent">0%</span>
                      </div>
                      <div class="monitor-bar-bg">
                        <div id="systemActualBar" class="monitor-bar-fill bg-blue-500" style="width:0%"></div>
                      </div>
                    </div>
                  </div>

                  <div class="space-y-4 max-h-[400px] overflow-y-auto pr-2" id="problemWeightList"></div>
                </div>
              </div>

              <!-- COL 2 -->
              <div class="lg:col-span-6 space-y-6">
                <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-5">
                  <h3 class="font-bold text-slate-800 text-base mb-4 flex items-center">
                    <span class="w-7 h-7 rounded bg-purple-100 text-purple-600 flex items-center justify-center mr-2">
                      <i class="fa-solid fa-brain"></i>
                    </span>
                    Mục tiêu Bloom (Toàn bài)
                  </h3>
                  <div class="grid grid-cols-2 gap-4" id="bloomConfigList"></div>
                  <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center">
                    <span class="font-bold text-slate-600 text-xs uppercase">Tổng Bloom Target:</span>
                    <span class="font-bold text-base" id="bloomTotalSum">0%</span>
                  </div>
                </div>

                <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-5">
                  <h3 class="font-bold text-slate-800 text-base mb-4 flex items-center justify-between">
                    <div class="flex items-center">
                      <span class="w-7 h-7 rounded bg-emerald-100 text-emerald-600 flex items-center justify-center mr-2">
                        <i class="fa-solid fa-bullseye"></i>
                      </span>
                      Mục tiêu CLO (Toàn bài)
                    </div>
                    <span class="text-xs text-slate-400">* Khóa theo VẤN ĐỀ: chuột phải vào ô</span>
                  </h3>

                  <div class="space-y-4" id="cloConfigList"></div>

                  <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center">
                    <span class="font-bold text-slate-600 text-xs uppercase">Tổng CLO Target:</span>
                    <span class="font-bold text-base" id="cloTotalSum">0%</span>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- VIEW 4: CLO MANAGER -->
        <div id="view-clo-manager" class="h-full p-8 overflow-y-auto hidden view-section">
          <div class="max-w-5xl mx-auto bg-white rounded-lg border border-slate-200 shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold text-slate-800 text-lg flex items-center">
                <span class="w-8 h-8 rounded bg-slate-100 text-slate-700 flex items-center justify-center mr-2">
                  <i class="fa-solid fa-gear"></i>
                </span>
                Quản lý CLO (Thêm / Sửa / Xóa)
              </h3>

              <button onclick="addCLOPrompt()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-bold">
                <i class="fa-solid fa-plus mr-2"></i> Thêm CLO
              </button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                  <tr>
                    <th class="px-3 py-3 w-28">Mã</th>
                    <th class="px-3 py-3 w-56">Tên ngắn</th>
                    <th class="px-3 py-3">Mô tả</th>
                    <th class="px-3 py-3 w-32 text-center">Target (%)</th>
                    <th class="px-3 py-3 w-28 text-center">Xóa</th>
                  </tr>
                </thead>
                <tbody id="cloManagerBody"></tbody>
              </table>
            </div>

            <div class="mt-4 text-xs text-slate-500">
              * Khóa CLO theo từng <b>VẤN ĐỀ</b>: chuột phải lên ô tương ứng trong ma trận.
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- NEW: Per-problem CLO modal -->
  <div id="problemCloModalBackdrop" onclick="closeProblemCLOModal()"></div>
  <div id="problemCloModal">
    <div class="pm-head">
      <div class="flex items-center gap-2">
        <span class="text-xs font-extrabold text-slate-600 uppercase">CLO áp dụng cho vấn đề</span>
        <span id="pmProblemTitle" class="text-xs font-bold text-slate-800"></span>
      </div>

      <div class="flex items-center gap-2">
        <button class="row-mini-btn" onclick="pmSelectAll(true)">Bật hết</button>
        <button class="row-mini-btn" onclick="pmSelectAll(false)">Tắt hết</button>
        <button class="text-slate-400 hover:text-red-500" onclick="closeProblemCLOModal()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
    </div>

    <div class="pm-body">
      <div class="text-xs text-slate-500 mb-3">
        * CLO <b>tắt</b> sẽ <b>disable</b> ô ở ma trận và AutoGen <b>không rải</b> vào các ô đó.
        (Khác với “LOCK”: LOCK vẫn cho phép dùng ô nhưng AutoGen bỏ qua)
      </div>

      <div id="pmCloList"></div>

      <div class="mt-3 flex justify-end gap-2">
        <button class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded text-xs font-bold"
                onclick="closeProblemCLOModal()">
          Đóng
        </button>
      </div>
    </div>
  </div>

  <!-- CELL EDITOR POPUP -->
  <div id="cellEditor">
    <div class="flex justify-between items-center mb-2">
      <div class="flex items-center gap-2">
        <span class="text-xs font-bold text-slate-500 uppercase">Cấu hình ô</span>

        <!-- Lock button (per-problem/per-cell) -->
        <button id="editorLockBtn"
                onclick="toggleLockFromCellEditor()"
                class="hidden border px-2 py-1 rounded text-xs font-bold hover:opacity-80 lock-off"
                title="Khóa CLO theo từng vấn đề (row) để auto-gen không rải vào ô này">
          <i id="editorLockIcon" class="fa-solid fa-lock-open mr-1"></i>
          <span id="editorLockText">Mở</span>
        </button>
      </div>

      <button onclick="closeEditor()" class="text-slate-400 hover:text-red-500">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>

    <div class="mb-3">
      <label class="text-xs block text-slate-600 mb-1">Số lượng câu hỏi:</label>
      <input type="number" id="editorQ"
             class="w-full border border-slate-300 rounded px-2 py-1 text-sm font-bold text-center focus:border-blue-500 outline-none"
             min="0">
    </div>

    <div class="mb-3">
      <label class="text-xs block text-slate-600 mb-1">Mức độ Bloom:</label>
      <div class="bloom-selector">
        <div onclick="selectBloom(1)" class="bloom-opt bloom-1 flex items-center justify-center text-[10px] font-bold" id="b-opt-1" title="Ghi nhớ">L1</div>
        <div onclick="selectBloom(2)" class="bloom-opt bloom-2 flex items-center justify-center text-[10px] font-bold" id="b-opt-2" title="Hiểu">L2</div>
        <div onclick="selectBloom(3)" class="bloom-opt bloom-3 flex items-center justify-center text-[10px] font-bold" id="b-opt-3" title="Áp dụng">L3</div>
        <div onclick="selectBloom(4)" class="bloom-opt bloom-4 flex items-center justify-center text-[10px] font-bold" id="b-opt-4" title="Phân tích">L4</div>
        <div onclick="selectBloom(5)" class="bloom-opt bloom-5 flex items-center justify-center text-[10px] font-bold" id="b-opt-5" title="Đánh giá">L5</div>
        <div onclick="selectBloom(6)" class="bloom-opt bloom-6 flex items-center justify-center text-[10px] font-bold" id="b-opt-6" title="Sáng tạo">L6</div>
      </div>
    </div>

    <div class="flex gap-2">
      <button onclick="saveCell()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs py-1.5 rounded font-bold">Lưu</button>
      <button onclick="clearCell()" class="flex-1 bg-slate-100 hover:bg-red-100 text-slate-600 hover:text-red-600 text-xs py-1.5 rounded font-bold">Xóa</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script>
    // =========================
    // ========== CLOUD =========
    // =========================
    const CLOUD_PROJECT_ID = "blueprint2026"; // đổi tên nếu muốn lưu nhiều blueprint khác nhau
    let cloudLastSavedAt = null;
    let cloudLastUrl = null;

    function setCloudStatus(text){
      const el = document.getElementById("cloudStatus");
      if(el) el.innerText = text;
    }

    function getState(){
      return { appData, clos, configTarget, currentSystemIdx, currentTab };
    }

    function applyState(state){
      if(!state) return;

      if(Array.isArray(state.appData)) appData = state.appData;
      if(Array.isArray(state.clos)) clos = state.clos;
      if(state.configTarget) configTarget = state.configTarget;
      if(Number.isInteger(state.currentSystemIdx)) currentSystemIdx = state.currentSystemIdx;
      if(state.currentTab) currentTab = state.currentTab;

      // ensure targets exist
      configTarget = configTarget || {};
      configTarget.bloom = configTarget.bloom || {1:20,2:30,3:30,4:10,5:5,6:5};
      configTarget.clo = configTarget.clo || {};

      // ensure all CLO keys exist
      clos.forEach(c=>{
        if(configTarget.clo[c.id] === undefined) configTarget.clo[c.id] = 0;
      });

      // ensure per-problem locks & disabled exist
      (appData || []).forEach(sys=>{
        (sys.problems || []).forEach(prob=>{
          if(!prob.cloLock) prob.cloLock = {};
          if(!prob.cloDisabled) prob.cloDisabled = {};
        });
      });

      // clamp idx
      if(currentSystemIdx < 0) currentSystemIdx = 0;
      if(currentSystemIdx >= appData.length) currentSystemIdx = Math.max(appData.length - 1, 0);

      renderSidebar();
      renderMatrix();
      renderCLOInfo();
      renderConfig();
      renderCLOManager();
      updateGlobalStats();

      // show correct tab
      switchTab(currentTab || "matrix");
    }

    async function saveToCloud(projectId = CLOUD_PROJECT_ID){
      try{
        setCloudStatus("đang lưu...");
        const payload = getState();

        const r = await fetch("/api/save", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ projectId, data: payload })
        });

        const j = await r.json();
        if(!r.ok) throw new Error(j.error || "Save failed");

        cloudLastSavedAt = new Date().toISOString();
        cloudLastUrl = j.url;

        setCloudStatus("đã lưu");
        localStorage.setItem("matrix_cloud_url_" + projectId, j.url);
        localStorage.setItem("matrix_cloud_savedAt_" + projectId, cloudLastSavedAt);

        alert("✅ Đã lưu lên cloud (Vercel Blob)!");
      }catch(e){
        console.error(e);
        setCloudStatus("lỗi");
        alert("❌ Lưu cloud lỗi: " + (e?.message || e));
      }
    }

    async function loadFromCloud(projectId = CLOUD_PROJECT_ID){
      try{
        setCloudStatus("đang tải...");
        const r = await fetch(`/api/load?projectId=${encodeURIComponent(projectId)}`, { cache:"no-store" });
        const j = await r.json();

        if(!j.found){
          setCloudStatus("chưa có dữ liệu");
          return alert("Chưa có dữ liệu cloud cho projectId: " + projectId);
        }

        applyState(j.data);
        cloudLastSavedAt = j.savedAt || null;
        cloudLastUrl = j.meta?.url || null;

        setCloudStatus("đã tải");
        alert("✅ Đã tải dữ liệu từ cloud!");
      }catch(e){
        console.error(e);
        setCloudStatus("lỗi");
        alert("❌ Tải cloud lỗi: " + (e?.message || e));
      }
    }

    // autosave (tùy chọn)
    let _autosaveTimer = null;
    function autoSaveDebounced(){
      const ENABLE_AUTOSAVE = false;
      if(!ENABLE_AUTOSAVE) return;

      if(_autosaveTimer) clearTimeout(_autosaveTimer);
      _autosaveTimer = setTimeout(()=>{
        saveToCloud().catch(()=>{});
      }, 1200);
    }

    // =========================
    // ====== APP LOGIC =========
    // =========================

    // --- DATA INITIALIZATION ---
    const initialData = [
      { name:"Bệnh Tạng phủ", weight:9.09, problems:[ { name:"Biện chứng tạng phủ" } ] },
      { name:"Bệnh hệ thống Tim mạch – hô hấp", weight:13.64, problems:[
        { name:"YHHĐ: Bệnh mạch vành mạn. YHCT: Tâm thống." },
        { name:"YHHĐ: Tăng huyết áp. YHCT: Huyễn vựng." },
        { name:"YHHĐ: Suy tĩnh mạch mạn tính." },
        { name:"YHHĐ: COPD." },
        { name:"YHHĐ: Hen phế quản. YHCT: Háo chứng, suyễn chứng." }
      ]},
      { name:"Bệnh hệ thống Tiết niệu – Nội tiết - Huyết học", weight:11.36, problems:[
        { name:"YHHĐ: Nhiễm khuẩn tiết niệu. YHCT: Lâm chứng." },
        { name:"YHHĐ: Béo phì. YHCT: Phì bạng." },
        { name:"YHHĐ: Đái tháo đường. YHCT: Tiêu khát." },
        { name:"YHHĐ: Thiếu máu mạn." }
      ]},
      { name:"Bệnh hệ thống Tiêu hóa - gan mật", weight:11.36, problems:[
        { name:"YHHĐ: Viêm loét dạ dày tá tràng. YHCT: Vị quản thống, Phúc mãn, Bĩ mãn, Chứng tr
