<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matrix Blueprint 2026 - Auto Gen AI</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- ‚úÖ SheetJS WITH STYLE (Export Excel gi·ªØ m√†u √¥) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

  <style>
    :root{
      --primary:#2563EB;
      --bg-body:#F8FAFC;
      --border-color:#E2E8F0;

      /* Bloom Colors */
      --bloom-1:#FEE2E2;
      --bloom-2:#FFEDD5;
      --bloom-3:#FEF9C3;
      --bloom-4:#DCFCE7;
      --bloom-5:#DBEAFE;
      --bloom-6:#F3E8FF;
    }

    body{
      font-family:'Inter',sans-serif;
      background-color:var(--bg-body);
      color:#1E293B;
      height:100vh;
      overflow:hidden;
      font-size:13px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:4px}
    ::-webkit-scrollbar-thumb:hover{background:#94A3B8}

    /* Navigation */
    .nav-item{cursor:pointer;transition:all .2s ease;border-bottom:2px solid transparent}
    .nav-item:hover{color:var(--primary);background-color:#EFF6FF}
    .nav-item.active{color:var(--primary);border-bottom-color:var(--primary);background-color:#EFF6FF;font-weight:600}

    /* Sidebar */
    .sidebar-item{
      border-radius:6px;transition:all .2s;cursor:pointer;border-left:3px solid transparent;position:relative
    }
    .sidebar-item:hover{background-color:#F1F5F9}
    .sidebar-item.active{
      background-color:#EFF6FF;color:#1D4ED8;border-left-color:#2563EB;font-weight:600
    }
    .sidebar-actions{display:none}
    .sidebar-item:hover .sidebar-actions{display:flex}

    /* Matrix */
    .matrix-container{
      box-shadow:0 4px 6px -1px rgba(0,0,0,.1);
      border-radius:8px;border:1px solid var(--border-color);
      background:#fff;overflow:hidden;display:flex;flex-direction:column;height:100%;
    }
    .matrix-table{width:100%;border-collapse:separate;border-spacing:0}
    .matrix-table th{
      background-color:#F8FAFC;color:#475569;font-weight:600;font-size:.75rem;text-transform:uppercase;
      padding:8px;border-bottom:1px solid var(--border-color);border-right:1px solid var(--border-color);
      position:sticky;top:0;z-index:10;text-align:center;
    }
    .matrix-table th.corner-header{
      left:0;z-index:20;background-color:#F1F5F9;text-align:left;min-width:400px;
    }
    .matrix-table td{
      border-bottom:1px solid var(--border-color);border-right:1px solid var(--border-color);
      padding:0;height:44px;position:relative;
    }
    .matrix-table td.row-header{
      padding:0 10px;position:sticky;left:0;background:#fff;z-index:5;font-weight:500;
      white-space:normal;line-height:1.3;max-width:400px;box-shadow:2px 0 5px -2px rgba(0,0,0,.05);
    }
    .row-action-btn{opacity:0;transition:opacity .2s}
    .matrix-table tr:hover .row-action-btn{opacity:1}
    .matrix-table tr.footer-row td{
      background-color:#F1F5F9;position:sticky;bottom:0;z-index:9;border-top:2px solid #CBD5E1;
      font-weight:700;color:#1E40AF;
    }
    .matrix-table tr.footer-row td.row-header{
      z-index:15;text-align:right;padding-right:15px;color:#475569;text-transform:uppercase;font-size:.75rem;
    }

    /* Matrix cell */
    .matrix-cell{
      width:100%;height:100%;display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-weight:800;font-size:14px;transition:all .15s;
      user-select:none;
    }
    .matrix-cell:hover{filter:brightness(.95);box-shadow:inset 0 0 0 2px #94A3B8}
    .matrix-cell.empty{background:transparent;color:transparent}
    .matrix-cell.empty:hover{background:#F1F5F9}

    .bloom-1{background-color:var(--bloom-1);color:#991B1B}
    .bloom-2{background-color:var(--bloom-2);color:#9A3412}
    .bloom-3{background-color:var(--bloom-3);color:#854D0E}
    .bloom-4{background-color:var(--bloom-4);color:#166534}
    .bloom-5{background-color:var(--bloom-5);color:#1E40AF}
    .bloom-6{background-color:var(--bloom-6);color:#6B21A8}

    .legend-dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:4px;border:1px solid rgba(0,0,0,.1)}

    /* Popover Editor */
    #cellEditor{
      position:fixed;background:#fff;border:1px solid #CBD5E1;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1);
      border-radius:8px;padding:12px;z-index:100;display:none;width:260px;
    }
    .bloom-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:8px}
    .bloom-opt{height:30px;border-radius:4px;cursor:pointer;border:2px solid transparent}
    .bloom-opt.selected{border-color:#2563EB;transform:scale(.95)}

    .stat-card{background:#fff;border:1px solid #E2E8F0;border-radius:6px;padding:4px 10px;min-width:80px}

    /* Tabs */
    .tab-btn{padding:.5rem 1rem;font-weight:600;color:#64748B;border-bottom:2px solid transparent;cursor:pointer;transition:all .2s}
    .tab-btn:hover{color:#2563EB}
    .tab-btn.active{color:#2563EB;border-bottom-color:#2563EB}

    .config-input{
      width:60px;text-align:center;border:1px solid #CBD5E1;border-radius:4px;padding:4px;transition:all .2s;
    }
    .config-input:focus{border-color:#2563EB;outline:none}

    .clo-desc-input{
      width:100%;border:1px solid #E2E8F0;border-radius:4px;padding:8px;font-size:13px;outline:none;
      transition:border-color .2s;
    }
    .clo-desc-input:focus{border-color:#2563EB}

    /* Live bars */
    .monitor-bar-bg{width:100%;height:6px;background:#F1F5F9;border-radius:3px;overflow:hidden;margin-top:4px}
    .monitor-bar-fill{height:100%;transition:width .5s ease;border-radius:3px}

    .text-problem{white-space:normal;font-size:12px;line-height:1.4;outline:none;border:1px dashed transparent;padding:2px}
    .text-problem:focus{border-color:#94A3B8;background:#F8FAFC}

    /* Export menu */
    .export-group{position:relative}
    .export-dropdown{
      position:absolute;right:0;top:100%;margin-top:5px;background:#fff;border:1px solid #E2E8F0;
      border-radius:6px;box-shadow:0 10px 15px -3px rgba(0,0,0,.1);display:none;min-width:200px;z-index:50;
    }
    .export-group:hover .export-dropdown{display:block}
    .export-item{display:block;padding:8px 12px;font-size:13px;color:#334155;cursor:pointer}
    .export-item:hover{background-color:#F1F5F9;color:#0F172A}

    .cloud-pill{
      display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid #E2E8F0;border-radius:999px;
      font-size:12px;background:#fff;
    }

    /* Lock button UI (Cell editor) */
    .lock-on  { background:#FEE2E2; color:#B91C1C; border-color:#FECACA; }
    .lock-off { background:#F1F5F9; color:#334155; border-color:#E2E8F0; }

    /* Cell locked overlay icon */
    .matrix-cell.locked{
      position:relative;
      opacity:0.55;
      filter:grayscale(0.2);
    }
    .matrix-cell.locked::after{
      content:"\f023"; /* fa-lock */
      font-family:"Font Awesome 6 Free";
      font-weight:900;
      position:absolute;
      top:4px; right:6px;
      font-size:10px;
      color:#ef4444;
      pointer-events:none;
    }

    /* tiny toast */
    #toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#0f172a;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      box-shadow:0 10px 20px rgba(0,0,0,.2);
      z-index:200;
      display:none;
      max-width:90vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* NEW: disabled cell (CLO not applied for this problem) */
    .matrix-cell.disabled {
      background: #f8fafc;
      color: #94a3b8;
      cursor: not-allowed;
      opacity: 0.75;
      filter: grayscale(0.35);
    }
    .matrix-cell.disabled:hover {
      box-shadow: none;
      filter: none;
    }

    /* NEW: mini button in row header */
    .row-mini-btn{
      font-size:11px;
      font-weight:800;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #e2e8f0;
      color:#475569;
      background:#fff;
    }
    .row-mini-btn:hover{
      background:#f1f5f9;
      color:#0f172a;
    }

    /* NEW: modal for per-problem CLO */
    #problemCloModalBackdrop{
      position:fixed; inset:0;
      background:rgba(15,23,42,.35);
      z-index:300;
      display:none;
    }
    #problemCloModal{
      position:fixed;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:min(520px,92vw);
      background:#fff;
      border:1px solid #e2e8f0;
      border-radius:12px;
      box-shadow:0 20px 40px rgba(0,0,0,.18);
      z-index:310;
      display:none;
      overflow:hidden;
    }
    #problemCloModal .pm-head{
      padding:12px 14px;
      background:#f8fafc;
      border-bottom:1px solid #e2e8f0;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    #problemCloModal .pm-body{
      padding:12px 14px;
      max-height:55vh;
      overflow:auto;
    }
    #problemCloModal .pm-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 8px;
      border:1px solid #f1f5f9;
      border-radius:10px;
      margin-bottom:8px;
    }
    #problemCloModal .pm-row:hover{ background:#f8fafc; }
    .pm-pill{
      font-size:11px;
      font-weight:800;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #e2e8f0;
      background:#fff;
      color:#334155;
    }
    .pm-pill.on { background:#dcfce7; border-color:#bbf7d0; color:#166534; }
    .pm-pill.off{ background:#fee2e2; border-color:#fecaca; color:#991b1b; }
  </style>
</head>

<body class="flex flex-col">
  <!-- HEADER -->
  <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 z-30 shadow-sm flex-none">
    <div class="flex items-center gap-6">
      <div class="flex items-center text-blue-700">
        <i class="fa-solid fa-layer-group text-xl mr-2"></i>
        <div>
          <h1 class="font-bold text-base leading-tight text-slate-800">
            Matrix<span class="text-blue-600">Builder</span>
            <span class="text-xs font-normal text-slate-500">PRO - 2026</span>
          </h1>
        </div>
      </div>

      <!-- Legend -->
      <div class="flex items-center gap-3 text-xs bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100 hidden md:flex">
        <span class="font-bold text-slate-400 mr-1">BLOOM:</span>
        <div class="flex items-center" title="1. Ghi nh·ªõ"><span class="legend-dot bloom-1"></span>L1</div>
        <div class="flex items-center" title="2. Hi·ªÉu"><span class="legend-dot bloom-2"></span>L2</div>
        <div class="flex items-center" title="3. √Åp d·ª•ng"><span class="legend-dot bloom-3"></span>L3</div>
        <div class="flex items-center" title="4. Ph√¢n t√≠ch"><span class="legend-dot bloom-4"></span>L4</div>
        <div class="flex items-center" title="5. ƒê√°nh gi√°"><span class="legend-dot bloom-5"></span>L5</div>
        <div class="flex items-center" title="6. S√°ng t·∫°o"><span class="legend-dot bloom-6"></span>L6</div>
      </div>

      <!-- Cloud indicator -->
      <div class="cloud-pill hidden lg:inline-flex" title="L∆∞u/T·∫£i state tr√™n Vercel Blob">
        <i class="fa-solid fa-cloud text-slate-500"></i>
        <span class="text-slate-600 font-semibold">Cloud:</span>
        <span id="cloudStatus" class="text-slate-500">ch∆∞a t·∫£i</span>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <div class="stat-card">
        <div class="text-[10px] text-slate-500 font-bold uppercase">T·ªïng c√¢u</div>
        <div class="text-lg font-bold text-slate-800" id="totalQuestionsDisplay">0</div>
      </div>

      <!-- CLOUD BUTTONS -->
      <button onclick="saveToCloud()" class="bg-slate-800 hover:bg-slate-900 text-white px-3 py-1.5 rounded text-sm font-medium flex items-center gap-2 transition-colors">
        <i class="fa-solid fa-cloud-arrow-up"></i> L∆∞u cloud
      </button>
      <button onclick="loadFromCloud()" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-3 py-1.5 rounded text-sm font-medium flex items-center gap-2 transition-colors">
        <i class="fa-solid fa-cloud-arrow-down"></i> T·∫£i cloud
      </button>

      <div class="export-group">
        <button class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded text-sm font-medium flex items-center gap-2 transition-colors">
          <i class="fa-solid fa-file-excel"></i> Xu·∫•t Excel <i class="fa-solid fa-chevron-down text-[10px]"></i>
        </button>
        <div class="export-dropdown">
          <div onclick="exportRealExcel()" class="export-item font-bold border-b border-slate-100">
            <i class="fa-solid fa-table mr-2 text-emerald-600"></i> Xu·∫•t Ma tr·∫≠n hi·ªán t·∫°i
          </div>
          <div onclick="downloadTemplate()" class="export-item text-slate-500">
            <i class="fa-solid fa-file-arrow-down mr-2"></i> T·∫£i Form m·∫´u g·ªëc
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <div class="flex flex-1 overflow-hidden relative">
    <!-- SIDEBAR -->
    <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-20">
      <div class="p-3 border-b border-slate-100 bg-slate-50 font-bold text-xs text-slate-500 uppercase flex justify-between">
        <span>H·ªá th·ªëng c∆° quan</span>
        <i class="fa-solid fa-list"></i>
      </div>

      <div class="flex-1 overflow-y-auto p-2 space-y-1" id="sidebarList"></div>

      <div class="p-3 border-t border-slate-200 flex flex-col gap-2">
        <button onclick="addSystem()" class="w-full py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 border border-blue-200 rounded text-xs font-bold transition-colors">
          <i class="fa-solid fa-folder-plus mr-1"></i> Th√™m H·ªá Th·ªëng
        </button>
        <button onclick="openCLOManager()" class="w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded text-xs font-bold transition-colors">
          <i class="fa-solid fa-bullseye mr-1"></i> Qu·∫£n l√Ω CLO (Th√™m/S·ª≠a/X√≥a)
        </button>
      </div>
    </aside>

    <!-- WORKSPACE -->
    <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden">
      <!-- Tabs & Toolbar -->
      <div class="h-12 bg-white border-b border-slate-200 flex items-center justify-between px-4 flex-none">
        <div class="flex gap-4 h-full">
          <button onclick="switchTab('matrix')" id="tab-matrix" class="tab-btn active">
            <i class="fa-solid fa-table mr-1"></i> Ma tr·∫≠n
          </button>
          <button onclick="switchTab('clo-info')" id="tab-clo-info" class="tab-btn">
            <i class="fa-solid fa-circle-info mr-1"></i> Th√¥ng tin CLO
          </button>
          <button onclick="switchTab('config')" id="tab-config" class="tab-btn">
            <i class="fa-solid fa-sliders mr-1"></i> C·∫•u h√¨nh & T·∫°o t·ª± ƒë·ªông
          </button>
          <button onclick="switchTab('clo-manager')" id="tab-clo-manager" class="tab-btn">
            <i class="fa-solid fa-gear mr-1"></i> Qu·∫£n l√Ω CLO
          </button>
        </div>

        <div class="text-xs text-slate-400 italic" id="matrixHint">
          * B·∫•m v√†o t√™n ƒë·ªÉ s·ª≠a. Ch·ªçn √¥ ƒë·ªÉ nh·∫≠p ƒëi·ªÉm. Chu·ªôt ph·∫£i l√™n √¥ ƒë·ªÉ kh√≥a/m·ªü kh√≥a nhanh.
        </div>
      </div>

      <!-- CONTENT VIEWS -->
      <div class="flex-1 overflow-hidden relative">

        <!-- VIEW 1: MATRIX -->
        <div id="view-matrix" class="h-full flex flex-col p-4 view-section">
          <div class="mb-2 flex items-center">
            <h2 id="currentSystemTitle" class="font-bold text-slate-700 text-lg mr-3">Ch·ªçn h·ªá th·ªëng...</h2>
            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-medium">ƒêang ch·ªânh s·ª≠a</span>
          </div>

          <div class="matrix-container flex-1">
            <div class="overflow-auto h-full relative">
              <table class="matrix-table" id="mainMatrix">
                <thead id="matrixHead"></thead>
                <tbody id="matrixBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW 2: CLO INFO -->
        <div id="view-clo-info" class="h-full p-8 overflow-y-auto hidden view-section">
          <div class="max-w-4xl mx-auto bg-white rounded-lg border border-slate-200 shadow-sm p-6">
            <h3 class="font-bold text-slate-800 text-lg mb-4 flex items-center">
              <span class="w-8 h-8 rounded bg-indigo-100 text-indigo-600 flex items-center justify-center mr-2">
                <i class="fa-solid fa-book-open"></i>
              </span>
              ƒê·ªãnh nghƒ©a Chu·∫©n ƒë·∫ßu ra (CLOs)
            </h3>

            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                  <tr>
                    <th class="px-4 py-3 w-24">M√£ CLO</th>
                    <th class="px-4 py-3 w-48">T√™n ng·∫Øn</th>
                    <th class="px-4 py-3">M√¥ t·∫£ chi ti·∫øt / ƒê·ªãnh nghƒ©a</th>
                  </tr>
                </thead>
                <tbody id="cloInfoBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW 3: CONFIG & AUTO GEN -->
        <div id="view-config" class="h-full p-6 overflow-y-auto hidden view-section">
          <div class="max-w-7xl mx-auto">

            <!-- Generator Panel -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-lg p-5 mb-6 flex items-center justify-between shadow-sm">
              <div>
                <h3 class="font-bold text-blue-800 text-lg mb-1">
                  <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>T·∫°o Ma Tr·∫≠n T·ª± ƒê·ªông (AI Distribution)
                </h3>
                <p class="text-sm text-blue-600 opacity-80">
                  H·ªá th·ªëng s·∫Ω r·∫£i c√¢u h·ªèi d·ª±a tr√™n <b>T·ªâ tr·ªçng %</b> c·ªßa c√°c H·ªá th·ªëng & V·∫•n ƒë·ªÅ ƒë√£ c·∫•u h√¨nh.
                  <br/>
                  <span class="text-xs">
                    * CLO c√≥ target to√†n b√†i. Kh√≥a/m·ªü theo t·ª´ng V·∫§N ƒê·ªÄ d√πng chu·ªôt ph·∫£i l√™n √¥ ho·∫∑c n√∫t kh√≥a trong editor.
                  </span>
                </p>
              </div>
              <div class="flex items-end gap-4">
                <div>
                  <label class="block text-xs font-bold text-blue-700 mb-1 uppercase">T·ªïng s·ªë c√¢u h·ªèi</label>
                  <input type="number" id="autoTotalQ" value="110"
                         class="w-32 text-center text-lg font-bold border-2 border-blue-200 rounded px-2 py-1 text-blue-800 focus:border-blue-500 outline-none">
                </div>
                <button onclick="runAutoGenerator()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded shadow font-bold transition-all transform hover:scale-105">
                  <i class="fa-solid fa-play mr-2"></i> B·∫ÆT ƒê·∫¶U T·∫†O
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

              <!-- COL 1 -->
              <div class="lg:col-span-6 space-y-6">
                <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-5">
                  <h3 class="font-bold text-slate-800 text-base mb-4 flex items-center justify-between">
                    <div class="flex items-center">
                      <span class="w-7 h-7 rounded bg-orange-100 text-orange-600 flex items-center justify-center mr-2">
                        <i class="fa-solid fa-weight-scale"></i>
                      </span>
                      T·ªâ tr·ªçng H·ªá Th·ªëng & V·∫•n ƒë·ªÅ
                    </div>
                    <span class="text-xs font-normal text-slate-400">(Nh·∫≠p t·ªâ tr·ªçng % h·ªá th·ªëng)</span>
                  </h3>

                  <div class="mb-4">
                    <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Ch·ªçn h·ªá th·ªëng ƒë·ªÉ c·∫•u h√¨nh:</label>
                    <select id="configSystemSelect" onchange="changeConfigSystem(this.value)"
                            class="w-full p-2 border border-slate-300 rounded text-sm font-semibold text-slate-700"></select>
                  </div>

                  <div class="p-3 bg-slate-50 border border-slate-200 rounded mb-4">
                    <div class="flex justify-between items-center">
                      <span class="text-sm font-bold text-slate-700">T·ªâ tr·ªçng H·ªá th·ªëng (%):</span>
                      <div class="flex items-center gap-2">
                        <input type="number" id="systemWeightInput" onchange="updateSystemWeight(this.value)"
                               class="config-input w-24 font-bold text-blue-700" step="0.01" placeholder="%">
                        <span class="text-xs text-slate-500 font-bold">%</span>
                      </div>
                    </div>
                    <div class="mt-2">
                      <div class="flex justify-between text-[10px] text-slate-500 mb-1">
                        <span>T·ªâ l·ªá c√¢u h·ªèi th·ª±c t·∫ø (to√†n b√†i):</span>
                        <span id="systemActualPercent">0%</span>
                      </div>
                      <div class="monitor-bar-bg">
                        <div id="systemActualBar" class="monitor-bar-fill bg-blue-500" style="width:0%"></div>
                      </div>
                    </div>
                  </div>

                  <div class="space-y-4 max-h-[400px] overflow-y-auto pr-2" id="problemWeightList"></div>
                </div>
              </div>

              <!-- COL 2 -->
              <div class="lg:col-span-6 space-y-6">
                <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-5">
                  <h3 class="font-bold text-slate-800 text-base mb-4 flex items-center">
                    <span class="w-7 h-7 rounded bg-purple-100 text-purple-600 flex items-center justify-center mr-2">
                      <i class="fa-solid fa-brain"></i>
                    </span>
                    M·ª•c ti√™u Bloom (To√†n b√†i)
                  </h3>
                  <div class="grid grid-cols-2 gap-4" id="bloomConfigList"></div>
                  <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center">
                    <span class="font-bold text-slate-600 text-xs uppercase">T·ªïng Bloom Target:</span>
                    <span class="font-bold text-base" id="bloomTotalSum">0%</span>
                  </div>
                </div>

                <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-5">
                  <h3 class="font-bold text-slate-800 text-base mb-4 flex items-center justify-between">
                    <div class="flex items-center">
                      <span class="w-7 h-7 rounded bg-emerald-100 text-emerald-600 flex items-center justify-center mr-2">
                        <i class="fa-solid fa-bullseye"></i>
                      </span>
                      M·ª•c ti√™u CLO (To√†n b√†i)
                    </div>
                    <span class="text-xs text-slate-400">* Kh√≥a theo V·∫§N ƒê·ªÄ: chu·ªôt ph·∫£i v√†o √¥</span>
                  </h3>

                  <div class="space-y-4" id="cloConfigList"></div>

                  <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center">
                    <span class="font-bold text-slate-600 text-xs uppercase">T·ªïng CLO Target:</span>
                    <span class="font-bold text-base" id="cloTotalSum">0%</span>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- VIEW 4: CLO MANAGER -->
        <div id="view-clo-manager" class="h-full p-8 overflow-y-auto hidden view-section">
          <div class="max-w-5xl mx-auto bg-white rounded-lg border border-slate-200 shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold text-slate-800 text-lg flex items-center">
                <span class="w-8 h-8 rounded bg-slate-100 text-slate-700 flex items-center justify-center mr-2">
                  <i class="fa-solid fa-gear"></i>
                </span>
                Qu·∫£n l√Ω CLO (Th√™m / S·ª≠a / X√≥a)
              </h3>

              <button onclick="addCLOPrompt()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-bold">
                <i class="fa-solid fa-plus mr-2"></i> Th√™m CLO
              </button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                  <tr>
                    <th class="px-3 py-3 w-28">M√£</th>
                    <th class="px-3 py-3 w-56">T√™n ng·∫Øn</th>
                    <th class="px-3 py-3">M√¥ t·∫£</th>
                    <th class="px-3 py-3 w-32 text-center">Target (%)</th>
                    <th class="px-3 py-3 w-28 text-center">X√≥a</th>
                  </tr>
                </thead>
                <tbody id="cloManagerBody"></tbody>
              </table>
            </div>

            <div class="mt-4 text-xs text-slate-500">
              * Kh√≥a CLO theo t·ª´ng <b>V·∫§N ƒê·ªÄ</b>: chu·ªôt ph·∫£i l√™n √¥ t∆∞∆°ng ·ª©ng trong ma tr·∫≠n.
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- NEW: Per-problem CLO modal -->
  <div id="problemCloModalBackdrop" onclick="closeProblemCLOModal()"></div>
  <div id="problemCloModal">
    <div class="pm-head">
      <div class="flex items-center gap-2">
        <span class="text-xs font-extrabold text-slate-600 uppercase">CLO √°p d·ª•ng cho v·∫•n ƒë·ªÅ</span>
        <span id="pmProblemTitle" class="text-xs font-bold text-slate-800"></span>
      </div>

      <div class="flex items-center gap-2">
        <button class="row-mini-btn" onclick="pmSelectAll(true)">B·∫≠t h·∫øt</button>
        <button class="row-mini-btn" onclick="pmSelectAll(false)">T·∫Øt h·∫øt</button>
        <button class="text-slate-400 hover:text-red-500" onclick="closeProblemCLOModal()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
    </div>

    <div class="pm-body">
      <div class="text-xs text-slate-500 mb-3">
        * CLO <b>t·∫Øt</b> s·∫Ω <b>disable</b> √¥ ·ªü ma tr·∫≠n v√† AutoGen <b>kh√¥ng r·∫£i</b> v√†o c√°c √¥ ƒë√≥.
        (Kh√°c v·ªõi ‚ÄúLOCK‚Äù: LOCK v·∫´n cho ph√©p d√πng √¥ nh∆∞ng AutoGen b·ªè qua)
      </div>

      <div id="pmCloList"></div>

      <div class="mt-3 flex justify-end gap-2">
        <button class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded text-xs font-bold"
                onclick="closeProblemCLOModal()">
          ƒê√≥ng
        </button>
      </div>
    </div>
  </div>

  <!-- CELL EDITOR POPUP -->
  <div id="cellEditor">
    <div class="flex justify-between items-center mb-2">
      <div class="flex items-center gap-2">
        <span class="text-xs font-bold text-slate-500 uppercase">C·∫•u h√¨nh √¥</span>

        <!-- Lock button (per-problem/per-cell) -->
        <button id="editorLockBtn"
                onclick="toggleLockFromCellEditor()"
                class="hidden border px-2 py-1 rounded text-xs font-bold hover:opacity-80 lock-off"
                title="Kh√≥a CLO theo t·ª´ng v·∫•n ƒë·ªÅ (row) ƒë·ªÉ auto-gen kh√¥ng r·∫£i v√†o √¥ n√†y">
          <i id="editorLockIcon" class="fa-solid fa-lock-open mr-1"></i>
          <span id="editorLockText">M·ªü</span>
        </button>
      </div>

      <button onclick="closeEditor()" class="text-slate-400 hover:text-red-500">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>

    <div class="mb-3">
      <label class="text-xs block text-slate-600 mb-1">S·ªë l∆∞·ª£ng c√¢u h·ªèi:</label>
      <input type="number" id="editorQ"
             class="w-full border border-slate-300 rounded px-2 py-1 text-sm font-bold text-center focus:border-blue-500 outline-none"
             min="0">
    </div>

    <div class="mb-3">
      <label class="text-xs block text-slate-600 mb-1">M·ª©c ƒë·ªô Bloom:</label>
      <div class="bloom-selector">
        <div onclick="selectBloom(1)" class="bloom-opt bloom-1 flex items-center justify-center text-[10px] font-bold" id="b-opt-1" title="Ghi nh·ªõ">L1</div>
        <div onclick="selectBloom(2)" class="bloom-opt bloom-2 flex items-center justify-center text-[10px] font-bold" id="b-opt-2" title="Hi·ªÉu">L2</div>
        <div onclick="selectBloom(3)" class="bloom-opt bloom-3 flex items-center justify-center text-[10px] font-bold" id="b-opt-3" title="√Åp d·ª•ng">L3</div>
        <div onclick="selectBloom(4)" class="bloom-opt bloom-4 flex items-center justify-center text-[10px] font-bold" id="b-opt-4" title="Ph√¢n t√≠ch">L4</div>
        <div onclick="selectBloom(5)" class="bloom-opt bloom-5 flex items-center justify-center text-[10px] font-bold" id="b-opt-5" title="ƒê√°nh gi√°">L5</div>
        <div onclick="selectBloom(6)" class="bloom-opt bloom-6 flex items-center justify-center text-[10px] font-bold" id="b-opt-6" title="S√°ng t·∫°o">L6</div>
      </div>
    </div>

    <div class="flex gap-2">
      <button onclick="saveCell()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs py-1.5 rounded font-bold">L∆∞u</button>
      <button onclick="clearCell()" class="flex-1 bg-slate-100 hover:bg-red-100 text-slate-600 hover:text-red-600 text-xs py-1.5 rounded font-bold">X√≥a</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script>
    // =========================
    // ========== CLOUD =========
    // =========================
    const CLOUD_PROJECT_ID = "blueprint2026"; // ƒë·ªïi t√™n n·∫øu mu·ªën l∆∞u nhi·ªÅu blueprint kh√°c nhau
    let cloudLastSavedAt = null;
    let cloudLastUrl = null;

    function setCloudStatus(text){
      const el = document.getElementById("cloudStatus");
      if(el) el.innerText = text;
    }

    function getState(){
      return { appData, clos, configTarget, currentSystemIdx, currentTab };
    }

    function applyState(state){
      if(!state) return;

      if(Array.isArray(state.appData)) appData = state.appData;
      if(Array.isArray(state.clos)) clos = state.clos;
      if(state.configTarget) configTarget = state.configTarget;
      if(Number.isInteger(state.currentSystemIdx)) currentSystemIdx = state.currentSystemIdx;
      if(state.currentTab) currentTab = state.currentTab;

      // ensure targets exist
      configTarget = configTarget || {};
      configTarget.bloom = configTarget.bloom || {1:20,2:30,3:30,4:10,5:5,6:5};
      configTarget.clo = configTarget.clo || {};

      // ensure all CLO keys exist
      clos.forEach(c=>{
        if(configTarget.clo[c.id] === undefined) configTarget.clo[c.id] = 0;
      });

      // ensure per-problem locks & disabled exist
      (appData || []).forEach(sys=>{
        (sys.problems || []).forEach(prob=>{
          if(!prob.cloLock) prob.cloLock = {};
          if(!prob.cloDisabled) prob.cloDisabled = {};
        });
      });

      // clamp idx
      if(currentSystemIdx < 0) currentSystemIdx = 0;
      if(currentSystemIdx >= appData.length) currentSystemIdx = Math.max(appData.length - 1, 0);

      renderSidebar();
      renderMatrix();
      renderCLOInfo();
      renderConfig();
      renderCLOManager();
      updateGlobalStats();

      // show correct tab
      switchTab(currentTab || "matrix");
    }

    async function saveToCloud(projectId = CLOUD_PROJECT_ID){
      try{
        setCloudStatus("ƒëang l∆∞u...");
        const payload = getState();

        const r = await fetch("/api/save", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ projectId, data: payload })
        });

        const j = await r.json();
        if(!r.ok) throw new Error(j.error || "Save failed");

        cloudLastSavedAt = new Date().toISOString();
        cloudLastUrl = j.url;

        setCloudStatus("ƒë√£ l∆∞u");
        localStorage.setItem("matrix_cloud_url_" + projectId, j.url);
        localStorage.setItem("matrix_cloud_savedAt_" + projectId, cloudLastSavedAt);

        alert("‚úÖ ƒê√£ l∆∞u l√™n cloud (Vercel Blob)!");
      }catch(e){
        console.error(e);
        setCloudStatus("l·ªói");
        alert("‚ùå L∆∞u cloud l·ªói: " + (e?.message || e));
      }
    }

    async function loadFromCloud(projectId = CLOUD_PROJECT_ID){
      try{
        setCloudStatus("ƒëang t·∫£i...");
        const r = await fetch(`/api/load?projectId=${encodeURIComponent(projectId)}`, { cache:"no-store" });
        const j = await r.json();

        if(!j.found){
          setCloudStatus("ch∆∞a c√≥ d·ªØ li·ªáu");
          return alert("Ch∆∞a c√≥ d·ªØ li·ªáu cloud cho projectId: " + projectId);
        }

        applyState(j.data);
        cloudLastSavedAt = j.savedAt || null;
        cloudLastUrl = j.meta?.url || null;

        setCloudStatus("ƒë√£ t·∫£i");
        alert("‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ cloud!");
      }catch(e){
        console.error(e);
        setCloudStatus("l·ªói");
        alert("‚ùå T·∫£i cloud l·ªói: " + (e?.message || e));
      }
    }

    // autosave (t√πy ch·ªçn)
    let _autosaveTimer = null;
    function autoSaveDebounced(){
      const ENABLE_AUTOSAVE = false;
      if(!ENABLE_AUTOSAVE) return;

      if(_autosaveTimer) clearTimeout(_autosaveTimer);
      _autosaveTimer = setTimeout(()=>{
        saveToCloud().catch(()=>{});
      }, 1200);
    }

    // =========================
    // ====== APP LOGIC =========
    // =========================

    // --- DATA INITIALIZATION ---
    const initialData = [
      { name:"B·ªánh T·∫°ng ph·ªß", weight:9.09, problems:[ { name:"Bi·ªán ch·ª©ng t·∫°ng ph·ªß" } ] },
      { name:"B·ªánh h·ªá th·ªëng Tim m·∫°ch ‚Äì h√¥ h·∫•p", weight:13.64, problems:[
        { name:"YHHƒê: B·ªánh m·∫°ch v√†nh m·∫°n. YHCT: T√¢m th·ªëng." },
        { name:"YHHƒê: TƒÉng huy·∫øt √°p. YHCT: Huy·ªÖn v·ª±ng." },
        { name:"YHHƒê: Suy tƒ©nh m·∫°ch m·∫°n t√≠nh." },
        { name:"YHHƒê: COPD." },
        { name:"YHHƒê: Hen ph·∫ø qu·∫£n. YHCT: H√°o ch·ª©ng, suy·ªÖn ch·ª©ng." }
      ]},
      { name:"B·ªánh h·ªá th·ªëng Ti·∫øt ni·ªáu ‚Äì N·ªôi ti·∫øt - Huy·∫øt h·ªçc", weight:11.36, problems:[
        { name:"YHHƒê: Nhi·ªÖm khu·∫©n ti·∫øt ni·ªáu. YHCT: L√¢m ch·ª©ng." },
        { name:"YHHƒê: B√©o ph√¨. YHCT: Ph√¨ b·∫°ng." },
        { name:"YHHƒê: ƒê√°i th√°o ƒë∆∞·ªùng. YHCT: Ti√™u kh√°t." },
        { name:"YHHƒê: Thi·∫øu m√°u m·∫°n." }
      ]},
      { name:"B·ªánh h·ªá th·ªëng Ti√™u h√≥a - gan m·∫≠t", weight:11.36, problems:[
        { name:"YHHƒê: Vi√™m lo√©t d·∫° d√†y t√° tr√†ng. YHCT: V·ªã qu·∫£n th·ªëng, Ph√∫c m√£n, Bƒ© m√£n, Ch·ª©ng tr∆∞·ªõng." },
        { name:"YHHƒê: GERD. YHCT: Hung th·ªëng, √Åi kh√≠." },
        { name:"YHHƒê: H·ªôi ch·ª©ng ru·ªôt k√≠ch th√≠ch. YHCT: Ti·∫øt t·∫£, Ph√∫c m√£n, Ti·ªán b√≠." },
        { name:"YHHƒê: Vi√™m gan m·∫°n. YHCT: Ho√†ng ƒë·∫£n, ch·ª©ng tr∆∞·ªõng." },
        { name:"YHHƒê: X∆° gan. YHCT: Ho√†ng ƒë·∫£n, C·ªï tr∆∞·ªõng." }
      ]},
      { name:"B·ªánh h·ªá th·ªëng Ng≈© quan ‚Äì L√£o khoa", weight:4.55, problems:[
        { name:"YHHƒê: B·ªánh th·∫≠n m·∫°n. YHCT: H∆∞ lao." },
        { name:"YHHƒê: Vi√™m m≈©i d·ªã ·ª©ng." }
      ]},
      { name:"B·ªánh h·ªá th·ªëng C∆° - x∆∞∆°ng ‚Äì kh·ªõp", weight:13.64, problems:[
        { name:"YHHƒê: Tho√°i h√≥a c·ªôt s·ªëng th·∫Øt l∆∞ng. YHCT: T√Ω ch·ª©ng, Y√™u th·ªëng." },
        { name:"YHHƒê: Tho√°i h√≥a kh·ªõp g·ªëi. YHCT: T√Ω ch·ª©ng, H·∫°c t·∫•t phong." },
        { name:"YHHƒê: Lo√£ng x∆∞∆°ng." },
        { name:"YHHƒê: Vi√™m kh·ªõp d·∫°ng th·∫•p. YHCT: T√Ω ch·ª©ng." },
        { name:"YHHƒê: Vi√™m kh·ªõp gout. YHCT: T√Ω ch·ª©ng, Th·ªëng phong." }
      ]},
      { name:"B·ªánh h·ªá th·ªëng Th·∫ßn kinh", weight:13.64, problems:[
        { name:"YHHƒê: Di ch·ª©ng tai bi·∫øn m·∫°ch m√°u n√£o. YHCT: B√°n th√¢n b·∫•t to·∫°i." },
        { name:"YHHƒê: ƒêau ƒë·∫ßu. YHCT: ƒê·∫ßu th·ªëng, ƒê√†m ch·ª©ng." },
        { name:"YHHƒê: ƒêau th·∫ßn kinh t·ªça. YHCT: Y√™u th·ªëng, Y√™u c∆∞·ªõc th·ªëng, T·ªça c·ªët phong, Ma m·ªôc b·∫•t nh√¢n." },
        { name:"YHHƒê: Li·ªát m·∫∑t. YHCT: Kh·∫©u nh√£n oa t√†." },
        { name:"YHHƒê: M·∫•t ng·ªß. YHCT: Th·∫•t mi√™n." }
      ]},
      { name:"B·ªánh h·ªá th·ªëng Nhi·ªÖm ‚Äì Ph·ª•", weight:9.09, problems:[
        { name:"YHHƒê: Vi√™m gan si√™u vi. YHCT: Ho√†ng ƒë·∫£n." },
        { name:"YHHƒê: S·ªët xu·∫•t huy·∫øt Dengue. YHCT: √în b·ªánh." },
        { name:"YHHƒê: ƒêau b·ª•ng kinh nguy√™n ph√°t. YHCT: Th·ªëng kinh." },
        { name:"YHHƒê: R·ªëi lo·∫°n m√£n kinh v√† chu m√£n kinh." }
      ]},
      { name:"B·ªánh h·ªá th·ªëng Nhi khoa", weight:4.55, problems:[
        { name:"YHHƒê: Suy dinh d∆∞·ª°ng ·ªü tr·∫ª em. YHCT: Cam t√≠ch." },
        { name:"YHHƒê: ƒê√°i d·∫ßm ·ªü tr·∫ª em. YHCT: D·∫° ni·ªáu." }
      ]},
      { name:"B·ªánh h·ªá th·ªëng Ngo·∫°i khoa - Da li·ªÖu", weight:9.09, problems:[
        { name:"YHHƒê: Trƒ©. YHCT: H·∫° trƒ©." },
        { name:"YHHƒê: S·ªèi ƒë∆∞·ªùng ni·ªáu. YHCT: L√¢m ch·ª©ng." },
        { name:"YHHƒê: M√†y ƒëay." },
        { name:"YHHƒê: M·ª•n tr·ª©ng c√°." }
      ]}
    ];

    let clos = [
      { id:"LO1", name:"Ch·∫©n ƒëo√°n", desc:"C√≥ kh·∫£ nƒÉng ch·∫©n ƒëo√°n x√°c ƒë·ªãnh v√† ph√¢n bi·ªát..." },
      { id:"LO2", name:"ƒêi·ªÅu tr·ªã", desc:"L·∫≠p k·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã v√† theo d√µi..." },
      { id:"LO3", name:"D·ª± ph√≤ng", desc:"T∆∞ v·∫•n gi√°o d·ª•c s·ª©c kh·ªèe..." },
      { id:"LO4", name:"C∆° ch·∫ø", desc:"Gi·∫£i th√≠ch c∆° ch·∫ø b·ªánh sinh..." }
    ];

    // Configuration Targets (Weights in %)
    let configTarget = {
      bloom: {1:20,2:30,3:30,4:10,5:5,6:5},
      clo: {}
    };
    clos.forEach(c=>{
      configTarget.clo[c.id] = 25;
    });

    // Data structure
    let appData = [];
    let currentSystemIdx = 0;
    let activeCell = { sysIdx:null, probIdx:null, cloId:null };
    let currentBloomSelection = 1;
    let currentTab = 'matrix';

    // =========================
    // ====== HELPERS ==========
    // =========================
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function ensureProblemLock(prob){
      if(!prob) return;
      if(!prob.cloLock) prob.cloLock = {};
    }

    function isCellLocked(prob, cloId){
      ensureProblemLock(prob);
      return !!prob.cloLock[cloId];
    }

    function toggleCellLock(prob, cloId){
      ensureProblemLock(prob);
      prob.cloLock[cloId] = !prob.cloLock[cloId];
      return !!prob.cloLock[cloId];
    }

    // NEW: per-problem CLO apply/disable
    function ensureProblemDisabled(prob){
      if(!prob) return;
      if(!prob.cloDisabled) prob.cloDisabled = {};
    }
    function isCLOApplied(prob, cloId){
      ensureProblemDisabled(prob);
      return !prob.cloDisabled[cloId];
    }
    function setCLOApplied(prob, cloId, applied){
      ensureProblemDisabled(prob);
      prob.cloDisabled[cloId] = !applied; // true = disabled
      return applied;
    }

    // toast
    let _toastTimer = null;
    function showToast(message){
      const el = document.getElementById("toast");
      if(!el) return;
      el.innerText = message;
      el.style.display = "block";
      if(_toastTimer) clearTimeout(_toastTimer);
      _toastTimer = setTimeout(()=>{ el.style.display = "none"; }, 1200);
    }

    // --- INIT ---
    function init(){
      // init local data (fallback)
      appData = initialData.map(cat=>({
        name:cat.name,
        weight:cat.weight,
        problems:cat.problems.map(p=>({
          name:p.name,
          weight:1,
          matrix:{},
          cloLock:{},
          cloDisabled:{} // NEW
        }))
      }));

      // render first
      renderSidebar();
      renderMatrix();
      renderCLOInfo();
      renderConfig();
      renderCLOManager();
      updateGlobalStats();

      // try auto-load once (cloud). If found, applyState will override.
      loadFromCloud().catch(()=>{});
    }

    // --- TAB NAVIGATION ---
    function switchTab(tab){
      currentTab = tab;

      document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active'));
      const tabBtn = document.getElementById('tab-' + tab);
      if(tabBtn) tabBtn.classList.add('active');

      document.querySelectorAll('.view-section').forEach(el=>el.classList.add('hidden'));
      const view = document.getElementById('view-' + tab);
      if(view) view.classList.remove('hidden');

      if(tab === 'matrix'){
        document.getElementById('matrixHint').style.visibility = 'visible';
        renderMatrix();
      }else{
        document.getElementById('matrixHint').style.visibility = 'hidden';
      }

      if(tab === 'clo-info') renderCLOInfo();
      if(tab === 'config'){
        populateConfigSystemSelect();
        renderConfig();
      }
      if(tab === 'clo-manager') renderCLOManager();
    }

    function openCLOManager(){
      switchTab('clo-manager');
    }

    // --- RENDER SIDEBAR ---
    function renderSidebar(){
      const list = document.getElementById('sidebarList');
      list.innerHTML = '';

      appData.forEach((sys, idx)=>{
        let qCount = 0;
        sys.problems.forEach(p=>{
          Object.values(p.matrix).forEach(cell=>{
            qCount += (parseInt(cell.q)||0);
          });
        });

        const div = document.createElement('div');
        div.className = `sidebar-item px-3 py-2 text-sm flex justify-between items-center group ${idx === currentSystemIdx ? 'active':'text-slate-600'}`;
        div.innerHTML = `
          <span class="truncate flex-1" onclick="selectSystem(${idx})">${escapeHtml(sys.name)}</span>
          <div class="flex items-center gap-2">
            <span class="text-[10px] bg-slate-200 text-slate-600 px-1.5 rounded-full font-bold" onclick="selectSystem(${idx})">${qCount}</span>
            <button onclick="deleteSystem(${idx})" title="X√≥a h·ªá th·ªëng"
                    class="sidebar-actions text-red-400 hover:text-red-600 hover:bg-red-50 p-1 rounded transition-colors">
              <i class="fa-solid fa-trash-can text-xs"></i>
            </button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    function selectSystem(idx){
      currentSystemIdx = idx;
      renderSidebar();

      if(currentTab === 'matrix') renderMatrix();
      if(currentTab === 'config'){
        const sel = document.getElementById('configSystemSelect');
        if(sel) sel.value = idx;
        renderConfig();
      }
    }

    // =========================
    // ====== RIGHT CLICK LOCK ==
    // =========================
    function onCellRightClick(e, pIdx, cloId){
      e.preventDefault();
      e.stopPropagation();

      const prob = appData?.[currentSystemIdx]?.problems?.[pIdx];
      if(!prob) return;

      const locked = toggleCellLock(prob, cloId);

      renderMatrix();
      renderConfig();
      renderSidebar();
      autoSaveDebounced();

      showToast(locked ? `üîí ƒê√£ kh√≥a ${cloId} cho v·∫•n ƒë·ªÅ n√†y` : `üîì ƒê√£ m·ªü ${cloId} cho v·∫•n ƒë·ªÅ n√†y`);
    }

    // --- RENDER MATRIX ---
    function renderMatrix(){
      const thead = document.getElementById('matrixHead');
      const tbody = document.getElementById('matrixBody');

      if(appData.length === 0){
        tbody.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-slate-500">Ch∆∞a c√≥ h·ªá th·ªëng n√†o. Vui l√≤ng th√™m m·ªõi.</td></tr>`;
        return;
      }

      // ensure configTarget keys exist
      configTarget.clo = configTarget.clo || {};
      clos.forEach(c=>{
        if(configTarget.clo[c.id] === undefined) configTarget.clo[c.id] = 0;
      });

      const sys = appData[currentSystemIdx];
      document.getElementById('currentSystemTitle').innerText = sys.name;

      let headHtml = `<tr><th class="corner-header">V·∫•n ƒë·ªÅ l√¢m s√†ng</th>`;
      clos.forEach(clo=>{
        headHtml += `
          <th style="min-width: 80px;" title="${escapeHtml(clo.name)}">
            <div class="flex items-center justify-center gap-1">
              <span>${escapeHtml(clo.id)}</span>
            </div>
          </th>
        `;
      });
      headHtml += `<th style="width:60px" class="bg-slate-100">T·ªïng</th></tr>`;
      thead.innerHTML = headHtml;

      tbody.innerHTML = '';

      let colTotals = {};
      clos.forEach(c=>colTotals[c.id]=0);
      let sysTotal = 0;

      sys.problems.forEach((prob, pIdx)=>{
        ensureProblemLock(prob);
        ensureProblemDisabled(prob);

        const tr = document.createElement('tr');

        let rowHtml = `
          <td class="row-header group">
            <div class="flex justify-between items-start gap-2">
              <div class="text-problem flex-1 mr-2" contenteditable="true"
                   onblur="updateProblemName(${pIdx}, this.innerText)">${escapeHtml(prob.name)}</div>

              <div class="flex items-center gap-1">
                <button class="row-mini-btn" onclick="openProblemCLOModal(${pIdx})" title="B·∫≠t/t·∫Øt CLO √°p d·ª•ng cho v·∫•n ƒë·ªÅ n√†y">
                  CLO
                </button>

                <button onclick="deleteProblem(${pIdx})" title="X√≥a v·∫•n ƒë·ªÅ"
                        class="row-action-btn text-red-300 hover:text-red-500 pt-0.5">
                  <i class="fa-solid fa-circle-xmark"></i>
                </button>
              </div>
            </div>
          </td>
        `;

        let rowTotal = 0;

        clos.forEach(clo=>{
          const applied = isCLOApplied(prob, clo.id);
          const disabled = !applied;
          const locked = !!prob.cloLock?.[clo.id];

          const cellData = prob.matrix[clo.id];
          const hasData = cellData && (parseInt(cellData.q)||0) > 0;
          const bloomClass = hasData ? `bloom-${cellData.bloom}` : 'empty';
          const content = hasData ? (parseInt(cellData.q)||0) : '';

          if(hasData){
            const val = parseInt(cellData.q)||0;
            rowTotal += val;
            colTotals[clo.id] += val;
            sysTotal += val;
          }

          rowHtml += `
            <td>
              <div class="matrix-cell ${bloomClass} ${locked ? 'locked' : ''} ${disabled ? 'disabled' : ''}"
                   ${disabled ? '' : `onclick="openCell(event, ${pIdx}, '${clo.id}')"`}
                   oncontextmenu="onCellRightClick(event, ${pIdx}, '${clo.id}')"
                   title="${
                     disabled
                       ? 'CLO n√†y ƒëang T·∫ÆT cho v·∫•n ƒë·ªÅ n√†y (b·∫•m n√∫t CLO ·ªü d√≤ng ƒë·ªÉ b·∫≠t)'
                       : (locked
                          ? 'LOCK (AutoGen b·ªè qua √¥ n√†y) - Chu·ªôt ph·∫£i ƒë·ªÉ m·ªü'
                          : 'Chu·ªôt ph·∫£i ƒë·ªÉ kh√≥a √¥ n√†y (AutoGen s·∫Ω b·ªè qua)')
                   }"
              >${disabled ? '' : content}</div>
            </td>
          `;
        });

        rowHtml += `<td class="text-center font-bold text-blue-700 bg-slate-50">${rowTotal || ''}</td>`;
        tr.innerHTML = rowHtml;
        tbody.appendChild(tr);
      });

      // footer total row
      const footerTr = document.createElement('tr');
      footerTr.className = 'footer-row';
      let footerHtml = `<td class="row-header">T·ªîNG C·ªòNG:</td>`;
      clos.forEach(clo=>{
        const val = colTotals[clo.id];
        footerHtml += `<td class="text-center">${val > 0 ? val : ''}</td>`;
      });
      footerHtml += `<td class="text-center text-lg">${sysTotal}</td>`;
      footerTr.innerHTML = footerHtml;
      tbody.appendChild(footerTr);

      // add row button
      const addRow = document.createElement('tr');
      addRow.innerHTML = `
        <td colspan="${clos.length + 2}" class="p-2 text-center">
          <button onclick="addProblem()"
                  class="text-blue-600 hover:text-blue-800 text-xs font-bold uppercase">
            <i class="fa-solid fa-plus"></i> Th√™m v·∫•n ƒë·ªÅ
          </button>
        </td>
      `;
      tbody.appendChild(addRow);
    }

    // --- SYSTEM & PROBLEM MANAGEMENT ---
    function addSystem(){
      const name = prompt("Nh·∫≠p t√™n h·ªá th·ªëng m·ªõi:", "H·ªá th·ªëng m·ªõi");
      if(!name) return;

      appData.push({
        name:name,
        weight:10,
        problems:[{ name:"V·∫•n ƒë·ªÅ 1...", weight:1, matrix:{}, cloLock:{}, cloDisabled:{} }]
      });

      currentSystemIdx = appData.length - 1;
      renderSidebar();
      renderMatrix();
      renderConfig();
      updateGlobalStats();
      autoSaveDebounced();
    }

    function deleteSystem(idx){
      if(!appData[idx]) return;
      if(confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªá th·ªëng "${appData[idx].name}" kh√¥ng?`)){
        appData.splice(idx, 1);
        if(appData.length === 0){
          currentSystemIdx = 0;
        }else if(currentSystemIdx >= appData.length){
          currentSystemIdx = appData.length - 1;
        }
        renderSidebar();
        renderMatrix();
        renderConfig();
        updateGlobalStats();
        autoSaveDebounced();
      }
    }

    function updateProblemName(pIdx, val){
      if(appData[currentSystemIdx] && appData[currentSystemIdx].problems[pIdx]){
        appData[currentSystemIdx].problems[pIdx].name = (val || "").trim();
        renderConfig();
        renderSidebar();
        autoSaveDebounced();
      }
    }

    function addProblem(){
      if(appData.length === 0) return;
      appData[currentSystemIdx].problems.push({
        name:"V·∫•n ƒë·ªÅ m·ªõi...",
        weight:1,
        matrix:{},
        cloLock:{},
        cloDisabled:{}
      });
      renderMatrix();
      renderConfig();
      renderSidebar();
      updateGlobalStats();
      autoSaveDebounced();
    }

    function deleteProblem(pIdx){
      const prob = appData[currentSystemIdx]?.problems?.[pIdx];
      if(!prob) return;

      if(confirm(`X√≥a v·∫•n ƒë·ªÅ: "${prob.name}"?`)){
        appData[currentSystemIdx].problems.splice(pIdx, 1);
        renderMatrix();
        renderConfig();
        renderSidebar();
        updateGlobalStats();
        autoSaveDebounced();
      }
    }

    // --- RENDER CLO INFO ---
    function renderCLOInfo(){
      const tbody = document.getElementById('cloInfoBody');
      tbody.innerHTML = '';

      clos.forEach((clo, idx)=>{
        const tr = document.createElement('tr');
        tr.className = "border-b border-slate-100 hover:bg-slate-50";
        tr.innerHTML = `
          <td class="px-4 py-3 font-bold text-blue-600">${escapeHtml(clo.id)}</td>
          <td class="px-4 py-3">
            <input type="text" value="${escapeHtml(clo.name || '')}"
                   onchange="updateCLOData(${idx}, 'name', this.value)"
                   class="w-full bg-transparent border-b border-dashed border-slate-300 outline-none">
          </td>
          <td class="px-4 py-3">
            <textarea onchange="updateCLOData(${idx}, 'desc', this.value)"
                      class="clo-desc-input" rows="2">${escapeHtml(clo.desc || '')}</textarea>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updateCLOData(idx, field, val){
      if(!clos[idx]) return;
      clos[idx][field] = val;

      if(field === 'name') renderMatrix();
      renderConfig();
      renderCLOManager();
      autoSaveDebounced();
    }

    // --- CLO MANAGER (add/edit/delete/target) ---
    function renderCLOManager(){
      const body = document.getElementById('cloManagerBody');
      if(!body) return;

      configTarget.clo = configTarget.clo || {};
      clos.forEach(c=>{
        if(configTarget.clo[c.id] === undefined) configTarget.clo[c.id] = 0;
      });

      body.innerHTML = '';

      clos.forEach((clo, idx)=>{
        const target = parseInt(configTarget.clo[clo.id] || 0);

        const tr = document.createElement('tr');
        tr.className = "border-b border-slate-100 hover:bg-slate-50";

        tr.innerHTML = `
          <td class="px-3 py-3 font-extrabold text-slate-700">${escapeHtml(clo.id)}</td>
          <td class="px-3 py-3">
            <input class="w-full border border-slate-200 rounded px-2 py-1"
                   value="${escapeHtml(clo.name || '')}"
                   onchange="updateCLOData(${idx}, 'name', this.value)">
          </td>
          <td class="px-3 py-3">
            <input class="w-full border border-slate-200 rounded px-2 py-1"
                   value="${escapeHtml(clo.desc || '')}"
                   onchange="updateCLOData(${idx}, 'desc', this.value)">
          </td>
          <td class="px-3 py-3 text-center">
            <input type="number" class="config-input w-20 font-bold text-slate-700"
                   value="${target}"
                   onchange="updateCLOTarget('${clo.id}', this.value)">
          </td>
          <td class="px-3 py-3 text-center">
            <button class="border border-red-200 text-red-600 hover:bg-red-50 px-3 py-1 rounded text-xs font-bold"
                    onclick="deleteCLO('${clo.id}')"
                    title="X√≥a CLO (s·∫Ω x√≥a c·ªôt trong t·∫•t c·∫£ v·∫•n ƒë·ªÅ)">
              <i class="fa-solid fa-trash-can"></i>
            </button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    function addCLOPrompt(){
      const idRaw = prompt("Nh·∫≠p m√£ CLO m·ªõi (VD: LO5):", "LO5");
      if(!idRaw) return;

      const newId = idRaw.trim().toUpperCase();
      if(!newId) return;

      if(clos.some(c=>c.id === newId)){
        alert("‚ùå CLO n√†y ƒë√£ t·ªìn t·∫°i: " + newId);
        return;
      }

      const name = prompt("Nh·∫≠p t√™n ng·∫Øn cho " + newId + ":", newId) || newId;

      clos.push({ id:newId, name:name, desc:"" });

      configTarget.clo = configTarget.clo || {};
      configTarget.clo[newId] = 0;

      // ‚úÖ ONLY auto-ON for problems in CURRENT system (same group)
      const curSys = appData?.[currentSystemIdx];
      if(curSys){
        curSys.problems.forEach(prob=>{
          ensureProblemLock(prob);
          ensureProblemDisabled(prob);

          if(prob.cloLock[newId] === undefined) prob.cloLock[newId] = false;
          if(prob.cloDisabled[newId] === undefined) prob.cloDisabled[newId] = false; // ON
        });
      }

      // ‚úÖ other systems: default OFF (recommended to avoid undefined & keep it not applied)
      appData.forEach((sys, sIdx)=>{
        if(sIdx === currentSystemIdx) return;
        sys.problems.forEach(prob=>{
          ensureProblemLock(prob);
          ensureProblemDisabled(prob);

          if(prob.cloLock[newId] === undefined) prob.cloLock[newId] = false;
          if(prob.cloDisabled[newId] === undefined) prob.cloDisabled[newId] = true; // OFF
        });
      });

      renderMatrix();
      renderConfig();
      renderCLOInfo();
      renderCLOManager();
      autoSaveDebounced();
    }

    function updateCLOTarget(cloId, val){
      configTarget.clo[cloId] = parseInt(val) || 0;
      renderConfig();
      autoSaveDebounced();
    }

    function deleteCLO(cloId){
      if(!confirm(`X√≥a CLO "${cloId}"?\n- S·∫Ω x√≥a c·ªôt n√†y trong ma tr·∫≠n (m·ªçi v·∫•n ƒë·ªÅ)\n- Kh√¥ng th·ªÉ ho√†n t√°c n·∫øu ch∆∞a l∆∞u cloud.`)) return;

      // remove from clos list
      const idx = clos.findIndex(c=>c.id === cloId);
      if(idx === -1) return;
      clos.splice(idx, 1);

      // remove from targets
      if(configTarget?.clo) delete configTarget.clo[cloId];

      // remove from all matrices + locks + disabled
      appData.forEach(sys=>{
        sys.problems.forEach(prob=>{
          if(prob.matrix && prob.matrix[cloId]) delete prob.matrix[cloId];
          if(prob.cloLock && prob.cloLock[cloId] !== undefined) delete prob.cloLock[cloId];
          if(prob.cloDisabled && prob.cloDisabled[cloId] !== undefined) delete prob.cloDisabled[cloId];
        });
      });

      renderMatrix();
      renderConfig();
      renderCLOInfo();
      renderCLOManager();
      renderSidebar();
      updateGlobalStats();
      autoSaveDebounced();
    }

    // --- RENDER CONFIG & LIVE MONITOR ---
    function populateConfigSystemSelect(){
      const sel = document.getElementById('configSystemSelect');
      if(!sel) return;
      sel.innerHTML = '';

      appData.forEach((sys, idx)=>{
        const opt = document.createElement('option');
        opt.value = idx;
        opt.text = sys.name;
        if(idx === currentSystemIdx) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function changeConfigSystem(val){
      currentSystemIdx = parseInt(val);
      renderConfig();
    }

    function renderConfig(){
      if(appData.length === 0) return;

      // ensure targets exist
      configTarget.bloom = configTarget.bloom || {1:20,2:30,3:30,4:10,5:5,6:5};
      configTarget.clo = configTarget.clo || {};
      clos.forEach(c=>{
        if(configTarget.clo[c.id] === undefined) configTarget.clo[c.id] = 0;
      });

      const currentSys = appData[currentSystemIdx];
      const stats = calculateActualStats();

      // system weight
      const sysWeightInput = document.getElementById('systemWeightInput');
      if(sysWeightInput) sysWeightInput.value = currentSys.weight;

      const sysActual = stats.systemPercents[currentSystemIdx] || 0;
      const sysActualPercent = document.getElementById('systemActualPercent');
      const sysActualBar = document.getElementById('systemActualBar');
      if(sysActualPercent) sysActualPercent.innerText = sysActual + '%';
      if(sysActualBar) sysActualBar.style.width = sysActual + '%';

      // problem weights list
      const probList = document.getElementById('problemWeightList');
      if(probList){
        probList.innerHTML = '';
        const sysRelWeightTotal = currentSys.problems.reduce((a,b)=>a + (b.weight||0), 0);

        currentSys.problems.forEach((prob, pIdx)=>{
          const w = prob.weight || 0;
          const expectedShare = sysRelWeightTotal ? (w/sysRelWeightTotal)*100 : 0;

          const sysTotalQ = stats.systemCounts[currentSystemIdx] || 1;
          const probQ = stats.problemCounts[`${currentSystemIdx}-${pIdx}`] || 0;
          const probActual = Math.round((probQ / sysTotalQ) * 100);

          probList.innerHTML += `
            <div class="flex flex-col mb-3 pb-3 border-b border-slate-50">
              <div class="flex items-center justify-between gap-2">
                <div class="flex-1 font-medium text-slate-700 text-sm" title="${escapeHtml(prob.name)}">${escapeHtml(prob.name)}</div>
                <div class="flex items-center gap-1">
                  <span class="text-[10px] text-slate-400 mr-1">Tr·ªçng s·ªë:</span>
                  <input type="number" value="${w}" onchange="updateProblemWeight(${pIdx}, this.value)"
                         class="config-input w-14 text-right font-bold text-slate-700" placeholder="1">
                </div>
              </div>

              <div class="mt-1">
                <div class="flex justify-between text-[10px] text-slate-400">
                  <span>Th·ª±c t·∫ø (trong h·ªá): <b>${probActual}%</b> (M·ª•c ti√™u: ~${Math.round(expectedShare)}%)</span>
                </div>
                <div class="monitor-bar-bg h-1">
                  <div class="monitor-bar-fill ${Math.abs(probActual - expectedShare) > 10 ? 'bg-red-400':'bg-emerald-400'}"
                       style="width:${Math.min(probActual,100)}%"></div>
                </div>
              </div>
            </div>
          `;
        });
      }

      // bloom targets
      const bloomList = document.getElementById('bloomConfigList');
      if(bloomList){
        bloomList.innerHTML = '';
        let bloomTargetTotal = 0;

        [1,2,3,4,5,6].forEach(lvl=>{
          const target = configTarget.bloom[lvl] || 0;
          const actual = stats.bloomPercents[lvl] || 0;
          bloomTargetTotal += parseInt(target);

          bloomList.innerHTML += `
            <div class="p-2 bg-slate-50 rounded border border-slate-100">
              <div class="flex justify-between mb-1">
                <div class="text-xs font-bold text-slate-600">M·ª©c ${lvl}</div>
                <div class="flex items-center">
                  <input type="number" value="${target}"
                         onchange="updateConfig('bloom', ${lvl}, this.value)"
                         class="config-input w-10 py-0 text-center text-xs font-bold">
                  <span class="text-[10px] ml-1">%</span>
                </div>
              </div>
              <div class="monitor-bar-bg">
                <div class="monitor-bar-fill ${Math.abs(actual - target) > 5 ? 'bg-red-500':'bg-purple-500'}"
                     style="width:${Math.min(actual,100)}%"></div>
              </div>
              <div class="text-[10px] text-right mt-1 text-slate-500">Th·ª±c t·∫ø: <b>${actual}%</b></div>
            </div>
          `;
        });

        const bloomTotalSum = document.getElementById('bloomTotalSum');
        if(bloomTotalSum) bloomTotalSum.innerText = bloomTargetTotal + '%';
      }

      // CLO targets (to√†n b√†i)
      const cloList = document.getElementById('cloConfigList');
      if(cloList){
        cloList.innerHTML = '';
        let cloTargetTotal = 0;

        clos.forEach(clo=>{
          const target = configTarget.clo[clo.id] || 0;
          const actual = stats.cloPercents[clo.id] || 0;
          cloTargetTotal += parseInt(target);

          cloList.innerHTML += `
            <div class="flex items-center gap-3">
              <div class="w-16 text-sm font-medium text-slate-600 flex items-center gap-2">
                <span>${escapeHtml(clo.id)}</span>
              </div>

              <div class="flex-1">
                <div class="flex justify-between items-center mb-1">
                  <div class="monitor-bar-bg flex-1 mr-2">
                    <div class="monitor-bar-fill ${Math.abs(actual - target) > 5 ? 'bg-orange-500':'bg-emerald-500'}"
                         style="width:${Math.min(actual,100)}%"></div>
                  </div>
                  <span class="text-[10px] font-bold text-slate-500 w-8 text-right">${actual}%</span>
                </div>
              </div>

              <input type="number" value="${target}"
                     onchange="updateConfig('clo', '${clo.id}', this.value)"
                     class="config-input text-slate-700 font-bold">
            </div>
          `;
        });

        const cloTotalSum = document.getElementById('cloTotalSum');
        if(cloTotalSum) cloTotalSum.innerText = cloTargetTotal + '%';
      }
    }

    function updateConfig(type, id, value){
      if(type === 'bloom') configTarget.bloom[id] = parseInt(value) || 0;
      else configTarget.clo[id] = parseInt(value) || 0;

      renderConfig();
      autoSaveDebounced();
    }

    function updateSystemWeight(val){
      appData[currentSystemIdx].weight = parseFloat(val) || 0;
      renderConfig();
      autoSaveDebounced();
    }

    function updateProblemWeight(pIdx, val){
      appData[currentSystemIdx].problems[pIdx].weight = parseInt(val) || 0;
      renderConfig();
      autoSaveDebounced();
    }

    // =========================
    // ====== AUTO GENERATOR =====
    // =========================
    function runAutoGenerator(){
      const totalQ = parseInt(document.getElementById('autoTotalQ').value) || 100;

      if(!confirm("H·ªá th·ªëng s·∫Ω x√≥a d·ªØ li·ªáu hi·ªán t·∫°i v√† t·∫°o m·ªõi d·ª±a tr√™n c·∫•u h√¨nh t·ªâ tr·ªçng. Ti·∫øp t·ª•c?")) return;

      // clear existing (keep cloLock + cloDisabled)
      appData.forEach(sys=>sys.problems.forEach(p=>p.matrix = {}));

      // build bloom deck
      let bloomDeck = [];
      Object.keys(configTarget.bloom).forEach(lvl=>{
        const count = Math.round(totalQ * (configTarget.bloom[lvl] / 100));
        for(let i=0;i<count;i++) bloomDeck.push(parseInt(lvl));
      });
      while(bloomDeck.length < totalQ) bloomDeck.push(Math.floor(Math.random()*6)+1);
      bloomDeck = shuffle(bloomDeck);

      // build clo deck using targets (to√†n b√†i)
      let cloDeck = [];
      const totalTarget = clos.reduce((acc,c)=>acc + (parseInt(configTarget.clo[c.id]||0)), 0);

      if(totalTarget <= 0){
        for(let i=0;i<totalQ;i++){
          cloDeck.push(clos[Math.floor(Math.random()*clos.length)].id);
        }
      }else{
        clos.forEach(clo=>{
          const t = parseInt(configTarget.clo[clo.id] || 0);
          const count = Math.round(totalQ * (t / totalTarget));
          for(let i=0;i<count;i++) cloDeck.push(clo.id);
        });
        while(cloDeck.length < totalQ){
          cloDeck.push(clos[Math.floor(Math.random()*clos.length)].id);
        }
      }
      cloDeck = shuffle(cloDeck);

      // distribute by system weight + problem weight
      const totalSysWeight = appData.reduce((acc, sys)=>acc + (parseFloat(sys.weight)||0), 0);
      let currentQCount = 0;

      appData.forEach(sys=>{
        if(!sys.weight) return;
        let sysTargetQ = (parseFloat(sys.weight) / totalSysWeight) * totalQ;

        const totalProbWeight = sys.problems.reduce((acc, p)=>acc + (parseFloat(p.weight)||0), 0);

        sys.problems.forEach(prob=>{
          if(!prob.weight) return;
          ensureProblemLock(prob);
          ensureProblemDisabled(prob);

          let probTargetQ = (parseFloat(prob.weight) / totalProbWeight) * sysTargetQ;

          let count = Math.floor(probTargetQ);
          if(Math.random() < (probTargetQ - count)) count++;

          // eligible CLO for this problem = applied AND not locked
          const probEligible = clos
            .map(c=>c.id)
            .filter(id => isCLOApplied(prob, id) && !prob.cloLock?.[id]);

          if(probEligible.length === 0){
            // v·∫•n ƒë·ªÅ n√†y: kh√¥ng c√≤n CLO h·ª£p l·ªá -> b·ªè qua
            return;
          }

          for(let k=0;k<count;k++){
            if(currentQCount >= totalQ) break;

            // pick cloId respecting applied+lock
            let cloId = null;
            let tries = 0;

            while(tries < 30){
              const candidate = cloDeck.length
                ? cloDeck.pop()
                : probEligible[Math.floor(Math.random()*probEligible.length)];

              if(isCLOApplied(prob, candidate) && !prob.cloLock?.[candidate]){
                cloId = candidate;
                break;
              }
              tries++;
            }

            if(!cloId){
              cloId = probEligible[Math.floor(Math.random()*probEligible.length)];
            }

            const bloomLvl = bloomDeck.length ? bloomDeck.pop() : (Math.floor(Math.random()*6)+1);

            if(!prob.matrix[cloId]) prob.matrix[cloId] = { q: 0, bloom: bloomLvl };
            prob.matrix[cloId].q += 1;

            currentQCount++;
          }
        });
      });

      renderMatrix();
      renderSidebar();
      updateGlobalStats();
      renderConfig();
      renderCLOManager();
      autoSaveDebounced();

      alert(`‚úÖ ƒê√£ t·∫°o xong ma tr·∫≠n v·ªõi ${currentQCount} c√¢u h·ªèi.\n(√î b·ªã kh√≥a / CLO t·∫Øt theo v·∫•n ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c auto-gen b·ªè qua)`);
    }

    function shuffle(array){
      for(let i=array.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function calculateActualStats(){
      let total = 0;
      let bloomCounts = {1:0,2:0,3:0,4:0,5:0,6:0};
      let cloCounts = {};
      let systemCounts = {};
      let problemCounts = {};

      clos.forEach(c=>cloCounts[c.id]=0);

      appData.forEach((sys, sIdx)=>{
        systemCounts[sIdx] = 0;
        sys.problems.forEach((prob, pIdx)=>{
          let pCount = 0;
          Object.entries(prob.matrix || {}).forEach(([cloId, cell])=>{
            const q = parseInt(cell.q) || 0;
            if(q > 0){
              total += q;
              pCount += q;
              systemCounts[sIdx] += q;
              if(cloCounts[cloId] !== undefined) cloCounts[cloId] += q;
              if(cell.bloom) bloomCounts[cell.bloom] += q;
            }
          });
          problemCounts[`${sIdx}-${pIdx}`] = pCount;
        });
      });

      let bloomPercents = {};
      Object.keys(bloomCounts).forEach(k=>{
        bloomPercents[k] = total ? Math.round((bloomCounts[k]/total)*100) : 0;
      });

      let cloPercents = {};
      Object.keys(cloCounts).forEach(k=>{
        cloPercents[k] = total ? Math.round((cloCounts[k]/total)*100) : 0;
      });

      let systemPercents = {};
      Object.keys(systemCounts).forEach(k=>{
        systemPercents[k] = total ? ((systemCounts[k]/total)*100).toFixed(2) : 0;
      });

      return { total, bloomPercents, cloPercents, systemPercents, systemCounts, problemCounts };
    }

    // =========================
    // ====== CELL EDITOR =======
    // =========================
    function openCell(e, pIdx, cloId){
      e.stopPropagation();

      const prob = appData?.[currentSystemIdx]?.problems?.[pIdx];
      if(!prob) return;

      // If CLO not applied -> block opening editor
      if(!isCLOApplied(prob, cloId)){
        showToast(`‚ö†Ô∏è ${cloId} ƒëang T·∫ÆT cho v·∫•n ƒë·ªÅ n√†y (b·∫•m n√∫t CLO ·ªü d√≤ng ƒë·ªÉ b·∫≠t)`);
        return;
      }

      activeCell = { sysIdx: currentSystemIdx, probIdx: pIdx, cloId: cloId };

      const cellData = appData[currentSystemIdx].problems[pIdx].matrix[cloId] || { q:'', bloom:1 };
      document.getElementById('editorQ').value = cellData.q;
      selectBloom(cellData.bloom || 1);

      // show lock button status
      refreshCellEditorLockUI();

      const editor = document.getElementById('cellEditor');
      const rect = e.target.getBoundingClientRect();
      editor.style.display = 'block';
      editor.style.top = (rect.bottom + 5) + 'px';
      editor.style.left = (rect.left - 20) + 'px';
      if(rect.left + 260 > window.innerWidth) editor.style.left = (window.innerWidth - 280) + 'px';

      document.getElementById('editorQ').focus();
    }

    function selectBloom(lvl){
      currentBloomSelection = lvl;
      document.querySelectorAll('.bloom-opt').forEach(el=>el.classList.remove('selected'));
      const el = document.getElementById('b-opt-' + lvl);
      if(el) el.classList.add('selected');
    }

    function saveCell(){
      const qVal = parseInt(document.getElementById('editorQ').value);
      const prob = appData[activeCell.sysIdx].problems[activeCell.probIdx];

      if(qVal > 0){
        prob.matrix[activeCell.cloId] = { q: qVal, bloom: currentBloomSelection };
      }else{
        delete prob.matrix[activeCell.cloId];
      }

      closeEditor();
      renderMatrix();
      renderSidebar();
      updateGlobalStats();
      renderConfig();
      autoSaveDebounced();
    }

    function clearCell(){
      document.getElementById('editorQ').value = '';
      saveCell();
    }

    function closeEditor(){
      document.getElementById('cellEditor').style.display = 'none';
    }

    // =========================
    // === LOCK CLO IN EDITOR ===
    // =========================
    function refreshCellEditorLockUI(){
      const btn  = document.getElementById("editorLockBtn");
      const icon = document.getElementById("editorLockIcon");
      const text = document.getElementById("editorLockText");
      if(!btn || !icon || !text) return;
      if(!activeCell || !activeCell.cloId) return;

      const prob = appData?.[activeCell.sysIdx]?.problems?.[activeCell.probIdx];
      if(!prob) return;

      ensureProblemLock(prob);
      const cloId = activeCell.cloId;
      const locked = !!prob.cloLock[cloId];

      btn.classList.remove("hidden");
      btn.classList.toggle("lock-on", locked);
      btn.classList.toggle("lock-off", !locked);

      icon.className = `fa-solid ${locked ? "fa-lock" : "fa-lock-open"} mr-1`;
      text.innerText = locked ? `Kh√≥a ${cloId} (row)` : `M·ªü ${cloId} (row)`;
      btn.title = locked
        ? `√î (V·∫•n ƒë·ªÅ n√†y, ${cloId}) ƒëang KH√ìA ‚Üí AutoGen s·∫Ω KH√îNG r·∫£i v√†o √¥ n√†y`
        : `√î (V·∫•n ƒë·ªÅ n√†y, ${cloId}) ƒëang M·ªû ‚Üí AutoGen c√≥ th·ªÉ r·∫£i v√†o √¥ n√†y`;
    }

    function toggleLockFromCellEditor(){
      if(!activeCell || !activeCell.cloId) return;
      const prob = appData?.[activeCell.sysIdx]?.problems?.[activeCell.probIdx];
      if(!prob) return;

      const locked = toggleCellLock(prob, activeCell.cloId);

      refreshCellEditorLockUI();
      renderMatrix();
      renderConfig();
      renderSidebar();
      autoSaveDebounced();

      showToast(locked ? `üîí ƒê√£ kh√≥a ${activeCell.cloId} (row)` : `üîì ƒê√£ m·ªü ${activeCell.cloId} (row)`);
    }

    // =========================
    // == PER-PROBLEM CLO MODAL ==
    // =========================
    let pmActiveProblemIdx = null;

    function openProblemCLOModal(pIdx){
      const prob = appData?.[currentSystemIdx]?.problems?.[pIdx];
      if(!prob) return;

      pmActiveProblemIdx = pIdx;
      ensureProblemDisabled(prob);

      // ensure every CLO has a key (default ON)
      clos.forEach(c=>{
        if(prob.cloDisabled[c.id] === undefined) prob.cloDisabled[c.id] = false;
      });

      const title = document.getElementById("pmProblemTitle");
      if(title) title.innerText = `‚Äî ${prob.name || ""}`;

      renderProblemCLOList();

      document.getElementById("problemCloModalBackdrop").style.display = "block";
      document.getElementById("problemCloModal").style.display = "block";
    }

    function closeProblemCLOModal(){
      pmActiveProblemIdx = null;
      document.getElementById("problemCloModalBackdrop").style.display = "none";
      document.getElementById("problemCloModal").style.display = "none";
    }

    function renderProblemCLOList(){
      const wrap = document.getElementById("pmCloList");
      if(!wrap) return;

      const prob = appData?.[currentSystemIdx]?.problems?.[pmActiveProblemIdx];
      if(!prob) return;

      ensureProblemDisabled(prob);

      wrap.innerHTML = "";

      clos.forEach(clo=>{
        const applied = isCLOApplied(prob, clo.id);

        const row = document.createElement("div");
        row.className = "pm-row";
        row.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="pm-pill ${applied ? 'on' : 'off'}">${applied ? 'ON' : 'OFF'}</span>
            <div>
              <div class="text-sm font-extrabold text-slate-700">${escapeHtml(clo.id)} ‚Äî ${escapeHtml(clo.name||'')}</div>
              <div class="text-xs text-slate-400">${escapeHtml(clo.desc||'')}</div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-xs font-bold text-slate-600 flex items-center gap-2 cursor-pointer">
              <input type="checkbox" ${applied ? "checked" : ""} onchange="pmToggleCLO('${clo.id}', this.checked)">
              √Åp d·ª•ng
            </label>
          </div>
        `;
        wrap.appendChild(row);
      });
    }

    function pmToggleCLO(cloId, applied){
      const prob = appData?.[currentSystemIdx]?.problems?.[pmActiveProblemIdx];
      if(!prob) return;

      setCLOApplied(prob, cloId, applied);

      // optional: when OFF, also force LOCK to keep AutoGen behavior consistent
      if(!applied){
        ensureProblemLock(prob);
        prob.cloLock[cloId] = true;
      }

      renderProblemCLOList();
      closeEditor();
      renderMatrix();
      renderConfig();
      renderSidebar();
      autoSaveDebounced();
    }

    function pmSelectAll(applied){
      const prob = appData?.[currentSystemIdx]?.problems?.[pmActiveProblemIdx];
      if(!prob) return;

      clos.forEach(clo=>{
        setCLOApplied(prob, clo.id, applied);
        if(!applied){
          ensureProblemLock(prob);
          prob.cloLock[clo.id] = true;
        }
      });

      renderProblemCLOList();
      closeEditor();
      renderMatrix();
      renderConfig();
      renderSidebar();
      autoSaveDebounced();
    }

    // =========================
    // ====== EXPORT LOGIC ======
    // =========================
    function exportRealExcel(){
      if(!confirm("Xu·∫•t file Excel v·ªõi d·ªØ li·ªáu hi·ªán t·∫°i (k√®m m√†u Bloom)?")) return;

      // ====== Bloom fill colors (ARGB) ======
      const BLOOM_FILL = {
        1: "FFFEE2E2", // #FEE2E2
        2: "FFFFEDD5", // #FFEDD5
        3: "FFFEF9C3", // #FEF9C3
        4: "FFDCFCE7", // #DCFCE7
        5: "FFDBEAFE", // #DBEAFE
        6: "FFF3E8FF"  // #F3E8FF
      };

      const FILL_GREY   = "FFF1F5F9";
      const FILL_HEADER = "FFF8FAFC";
      const FILL_SYSROW = "FFEFF6FF";
      const FILL_TOTAL  = "FFF1F5F9";

      // ====== Data AoA ======
      const ws_data = [];
      const headers = ["STT","H·ªá th·ªëng / V·∫•n ƒë·ªÅ l√¢m s√†ng", ...clos.map(c=>c.id), "T·ªïng"];
      ws_data.push(headers);

      let grandTotal = 0;
      const colTotals = new Array(clos.length).fill(0);

      // Build rows
      appData.forEach((sys, sIdx)=>{
        const sysRow = [`${sIdx+1}`, sys.name.toUpperCase()];
        for(let i=0;i<clos.length;i++) sysRow.push("");
        sysRow.push(0);

        const sysRowIdx = ws_data.push(sysRow) - 1;
        let sysSum = 0;

        sys.problems.forEach((prob, pIdx)=>{
          ensureProblemLock(prob);
          ensureProblemDisabled(prob);

          const row = [`${sIdx+1}.${pIdx+1}`, prob.name];
          let rowSum = 0;

          clos.forEach((clo, cIdx)=>{
            const applied = isCLOApplied(prob, clo.id);
            const locked = !!prob.cloLock?.[clo.id];
            const cell = prob.matrix[clo.id];

            if(!applied){
              row.push("OFF");
              return;
            }

            if(cell && (parseInt(cell.q)||0) > 0){
              const q = parseInt(cell.q)||0;
              row.push(locked ? `${q} (LOCK)` : q);
              rowSum += q;
              colTotals[cIdx] += q;
            }else{
              row.push(locked ? "LOCK" : "");
            }
          });

          row.push(rowSum);
          sysSum += rowSum;
          ws_data.push(row);
        });

        ws_data[sysRowIdx][ws_data[sysRowIdx].length - 1] = sysSum;
        grandTotal += sysSum;
      });

      const footer = ["","T·ªîNG C·ªòNG", ...colTotals, grandTotal];
      ws_data.push(footer);

      // ====== Create workbook/sheet ======
      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.aoa_to_sheet(ws_data);
      ws1["!cols"] = [{wch:6},{wch:55}, ...clos.map(()=>({wch:14})), {wch:10}];

      // ====== Style helpers ======
      function baseCell(border=true){
        const s = {
          font: { name: "Inter", sz: 11, color: { rgb: "FF0F172A" } },
          alignment: { vertical: "center", horizontal: "center", wrapText: true }
        };
        if(border){
          s.border = {
            top:{style:"thin", color:{rgb:"FFE2E8F0"}},
            bottom:{style:"thin", color:{rgb:"FFE2E8F0"}},
            left:{style:"thin", color:{rgb:"FFE2E8F0"}},
            right:{style:"thin", color:{rgb:"FFE2E8F0"}}
          };
        }
        return s;
      }

      function fillStyle(argb){
        const s = baseCell(true);
        s.fill = { patternType:"solid", fgColor:{ rgb: argb } };
        return s;
      }

      function headerStyle(){
        const s = fillStyle(FILL_HEADER);
        s.font = { name:"Inter", sz:11, bold:true, color:{rgb:"FF334155"} };
        return s;
      }

      function sysRowStyle(){
        const s = fillStyle(FILL_SYSROW);
        s.font = { name:"Inter", sz:11, bold:true, color:{rgb:"FF1D4ED8"} };
        s.alignment.horizontal = "left";
        return s;
      }

      function rowHeaderStyle(){
        const s = baseCell(true);
        s.alignment.horizontal = "left";
        return s;
      }

      function offStyle(){
        const s = fillStyle(FILL_GREY);
        s.font = { name:"Inter", sz:11, color:{rgb:"FF94A3B8"}, italic:true };
        return s;
      }

      function lockStyle(){
        const s = fillStyle(FILL_GREY);
        s.font = { name:"Inter", sz:11, color:{rgb:"FFB91C1C"}, bold:true };
        return s;
      }

      function bloomStyle(level){
        const s = fillStyle(BLOOM_FILL[level] || FILL_GREY);
        s.font = { name:"Inter", sz:12, bold:true, color:{rgb:"FF0F172A"} };
        return s;
      }

      function totalRowStyle(){
        const s = fillStyle(FILL_TOTAL);
        s.font = { name:"Inter", sz:12, bold:true, color:{rgb:"FF1E40AF"} };
        return s;
      }

      function setCellStyle(r, c, style){
        const ref = XLSX.utils.encode_cell({r, c});
        if(!ws1[ref]) ws1[ref] = { t: "s", v: "" };
        ws1[ref].s = style;
      }

      // Header row
      for(let c=0;c<headers.length;c++){
        setCellStyle(0, c, headerStyle());
      }
      // Column B header left
      setCellStyle(0, 1, (()=>{ const s=headerStyle(); s.alignment.horizontal="left"; return s; })());

      // Walk through rows again to apply styles
      let r = 1; // first data row after header

      appData.forEach((sys, sIdx)=>{
        // system row
        for(let c=0;c<headers.length;c++){
          setCellStyle(r, c, sysRowStyle());
        }
        setCellStyle(r, 1, (()=>{ const s=sysRowStyle(); s.alignment.horizontal="left"; return s; })());
        r++;

        // problem rows
        sys.problems.forEach((prob, pIdx)=>{
          ensureProblemLock(prob);
          ensureProblemDisabled(prob);

          setCellStyle(r, 0, baseCell(true));
          setCellStyle(r, 1, rowHeaderStyle());

          clos.forEach((clo, cIdx)=>{
            const applied = isCLOApplied(prob, clo.id);
            const locked = !!prob.cloLock?.[clo.id];
            const cell = prob.matrix[clo.id];
            const col = 2 + cIdx;

            if(!applied){
              setCellStyle(r, col, offStyle());
              return;
            }

            if(cell && (parseInt(cell.q)||0) > 0){
              setCellStyle(r, col, bloomStyle(parseInt(cell.bloom)||1));
            }else if(locked){
              setCellStyle(r, col, lockStyle());
            }else{
              setCellStyle(r, col, baseCell(true));
            }
          });

          // row total column
          setCellStyle(r, headers.length-1, baseCell(true));
          r++;
        });
      });

      // Footer total row
      const footerRowIndex = ws_data.length - 1;
      for(let c=0;c<headers.length;c++){
        setCellStyle(footerRowIndex, c, totalRowStyle());
      }
      setCellStyle(footerRowIndex, 1, (()=>{ const s=totalRowStyle(); s.alignment.horizontal="left"; return s; })());

      XLSX.utils.book_append_sheet(wb, ws1, "Ma tr·∫≠n");

      // Config sheet
      const info_data = [];
      info_data.push(["TH√îNG S·ªê C·∫§U H√åNH & TH·ªêNG K√ä",""]);
      info_data.push(["T·ªïng s·ªë c√¢u h·ªèi:", grandTotal]);
      info_data.push(["",""]);
      info_data.push(["M·ª§C TI√äU BLOOM (Target)","%"]);
      Object.entries(configTarget.bloom).forEach(([k,v])=>info_data.push([`M·ª©c ${k}`, v]));
      info_data.push(["",""]);
      info_data.push(["M·ª§C TI√äU CLO (Target)","%"]);
      clos.forEach(c=>{
        info_data.push([c.id, configTarget.clo[c.id]]);
      });
      info_data.push(["",""]);
      info_data.push(["GHI CH√ö",""]);
      info_data.push(["LOCK theo V·∫§N ƒê·ªÄ", "Chu·ªôt ph·∫£i l√™n √¥ ƒë·ªÉ toggle lock nhanh"]);
      info_data.push(["OFF theo V·∫§N ƒê·ªÄ", "B·∫•m n√∫t CLO ·ªü d√≤ng ƒë·ªÉ b·∫≠t/t·∫Øt CLO √°p d·ª•ng"]);

      const ws2 = XLSX.utils.aoa_to_sheet(info_data);
      ws2["!cols"] = [{wch:34},{wch:44}];
      XLSX.utils.book_append_sheet(wb, ws2, "C·∫•u h√¨nh");

      XLSX.writeFile(wb, "Matrix_Blueprint_Export.xlsx");
    }

    function downloadTemplate(){
      const assetLink = "assets/form test blueprint - trong so 5.2.2026.xlsx";
      const link = document.createElement('a');
      link.href = assetLink;
      link.download = 'Template_Form.xlsx';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function updateGlobalStats(){
      document.getElementById('totalQuestionsDisplay').innerText = calculateActualStats().total;
    }

    document.addEventListener('click', (e)=>{
      const editor = document.getElementById('cellEditor');
      if(editor.style.display === 'block' && !editor.contains(e.target) && !e.target.classList.contains('matrix-cell')){
        closeEditor();
      }
    });

    // Prevent browser context menu on matrix cells area (optional)
    document.addEventListener('contextmenu', (e)=>{
      if(e.target && e.target.classList && e.target.classList.contains('matrix-cell')){
        e.preventDefault();
      }
    });

    init();
  </script>
</body>
</html>
